{% extends "base.html" %}

{% block title %}Overtime Management - Workforce Scheduler{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #11998e;
        --primary-dark: #0e8071;
        --secondary-color: #38ef7d;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --dark: #2c3e50;
        --light-bg: #f8f9fa;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --hover-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }

    body {
        background-color: #f0f2f5;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Modern Header */
    .overtime-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 2.5rem 0;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .overtime-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 10px,
            rgba(255, 255, 255, 0.05) 10px,
            rgba(255, 255, 255, 0.05) 20px
        );
        animation: slide 20s linear infinite;
    }

    @keyframes slide {
        0% { transform: translate(0, 0); }
        100% { transform: translate(50px, 50px); }
    }

    .overtime-header h1 {
        position: relative;
        font-weight: 300;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .overtime-header h1 i {
        margin-right: 1rem;
        font-size: 2rem;
    }

    .overtime-header p {
        position: relative;
        opacity: 0.9;
        font-size: 1.1rem;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--hover-shadow);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--primary-color);
    }

    .stat-card.danger::before { background: var(--danger-color); }
    .stat-card.warning::before { background: var(--warning-color); }
    .stat-card.info::before { background: var(--info-color); }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-icon.primary { background: rgba(17, 153, 142, 0.1); color: var(--primary-color); }
    .stat-icon.danger { background: rgba(220, 53, 69, 0.1); color: var(--danger-color); }
    .stat-icon.warning { background: rgba(255, 193, 7, 0.1); color: var(--warning-color); }
    .stat-icon.info { background: rgba(23, 162, 184, 0.1); color: var(--info-color); }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--dark);
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-trend {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        font-size: 0.875rem;
    }

    .trend-up { color: var(--danger-color); }
    .trend-down { color: var(--primary-color); }

    /* Alert Section */
    .alert-banner {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: none;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .alert-banner i {
        font-size: 1.5rem;
        color: #856404;
    }

    /* Filter Section */
    .filter-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .filter-header h5 {
        margin: 0;
        color: var(--dark);
        font-weight: 600;
    }

    .filter-toggle {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 1.25rem;
        transition: transform 0.3s ease;
    }

    .filter-toggle.collapsed { transform: rotate(180deg); }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .filter-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .filter-group .form-control,
    .filter-group .form-select {
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }

    .filter-group .form-control:focus,
    .filter-group .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(17, 153, 142, 0.15);
    }

    .btn-apply-filters {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-top: 1.5rem;
    }

    .btn-apply-filters:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
        color: white;
    }

    /* Multi-Level Sorter */
    .sorter-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        border: 2px solid transparent;
        transition: border-color 0.3s ease;
    }

    .sorter-card:hover {
        border-color: var(--primary-color);
    }

    .sorter-level {
        background: var(--light-bg);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
    }

    .sorter-level:not(.disabled):hover {
        background: #e8f5f2;
    }

    .sorter-level.disabled {
        opacity: 0.4;
        pointer-events: none;
    }

    .level-badge {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 0.375rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
        min-width: 50px;
        text-align: center;
    }

    .sort-direction-toggle {
        margin-left: auto;
        display: flex;
        gap: 0.5rem;
    }

    .sort-direction-toggle button {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }

    .sort-direction-toggle button.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Data Table */
    .table-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        overflow: hidden;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .table-header h4 {
        margin: 0;
        color: var(--dark);
        font-weight: 600;
    }

    .table-actions {
        display: flex;
        gap: 0.5rem;
    }

    .overtime-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .overtime-table th {
        background: var(--light-bg);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        color: #6c757d;
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 10;
        cursor: pointer;
        user-select: none;
        transition: all 0.3s ease;
    }

    .overtime-table th:hover {
        background: #e2e6ea;
        color: var(--primary-color);
    }

    .overtime-table td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .overtime-table tbody tr {
        transition: all 0.3s ease;
    }

    .overtime-table tbody tr:hover {
        background: #f8f9fa;
        transform: scale(1.01);
    }

    /* Employee Info */
    .employee-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .employee-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        color: white;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    }

    .employee-details {
        flex: 1;
    }

    .employee-name {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.125rem;
    }

    .employee-id {
        font-size: 0.75rem;
        color: #6c757d;
    }

    /* Crew Badges */
    .crew-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .crew-a { background: #e3f2fd; color: #1565c0; }
    .crew-b { background: #f3e5f5; color: #6a1b9a; }
    .crew-c { background: #e8f5e9; color: #2e7d32; }
    .crew-d { background: #fff3e0; color: #e65100; }

    /* Overtime Values */
    .ot-value {
        font-weight: 600;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        text-align: center;
        min-width: 60px;
        display: inline-block;
    }

    .ot-low { background: #d4edda; color: #155724; }
    .ot-medium { background: #fff3cd; color: #856404; }
    .ot-high { background: #f8d7da; color: #721c24; }
    .ot-critical { background: #721c24; color: white; }

    /* Trend Indicators */
    .trend-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .trend-badge.up { background: #f8d7da; color: #721c24; }
    .trend-badge.down { background: #d4edda; color: #155724; }
    .trend-badge.stable { background: #e2e3e5; color: #383d41; }

    /* Export Section */
    .export-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-top: 2rem;
        color: white;
    }

    .export-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .export-header h5 {
        font-size: 1.5rem;
        font-weight: 300;
        margin-bottom: 0.5rem;
    }

    .export-header p {
        opacity: 0.9;
        margin: 0;
    }

    .export-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .export-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 1rem;
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        backdrop-filter: blur(10px);
    }

    .export-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .export-btn i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    .export-btn-label {
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-state i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }

    .empty-state h5 {
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #adb5bd;
    }

    /* Loading States */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .overtime-header h1 { font-size: 2rem; }
        .stats-grid { grid-template-columns: 1fr; }
        .filter-row { grid-template-columns: 1fr; }
        .export-options { grid-template-columns: 1fr; }
        
        .overtime-table {
            font-size: 0.875rem;
        }
        
        .employee-card {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    /* Print Styles */
    @media print {
        .filter-card, .sorter-card, .export-card, .btn, .navbar {
            display: none !important;
        }
        
        .overtime-header {
            background: none;
            color: black;
            padding: 1rem 0;
        }
        
        .table-card {
            box-shadow: none;
            padding: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Modern Header Section -->
<div class="overtime-header">
    <div class="container-fluid">
        <h1><i class="bi bi-clock-history"></i> Overtime Management</h1>
        <p>13-Week Rolling Overview â€¢ {{ start_date.strftime('%B %d') }} - {{ end_date.strftime('%B %d, %Y') }}</p>
    </div>
</div>

<div class="container-fluid">
    <!-- Alert Section -->
    {% if high_overtime_employees %}
    <div class="alert-banner">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <div>
            <strong>Overtime Alert:</strong> {{ high_overtime_employees|length }} employee(s) are averaging 15+ hours of overtime per week.
            <a href="#" class="text-warning ms-2" onclick="filterHighOT()">View Details</a>
        </div>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="stat-value">{{ "{:,.0f}".format(total_overtime_hours) }}</div>
            <div class="stat-label">Total OT Hours</div>
            <div class="stat-trend trend-up">
                <i class="bi bi-arrow-up"></i> 12%
            </div>
        </div>

        <div class="stat-card info">
            <div class="stat-icon info">
                <i class="bi bi-people-fill"></i>
            </div>
            <div class="stat-value">{{ employees_with_overtime }}</div>
            <div class="stat-label">Employees with OT</div>
        </div>

        <div class="stat-card warning">
            <div class="stat-icon warning">
                <i class="bi bi-graph-up"></i>
            </div>
            <div class="stat-value">{{ avg_overtime }}</div>
            <div class="stat-label">Average OT Hours</div>
        </div>

        <div class="stat-card danger">
            <div class="stat-icon danger">
                <i class="bi bi-exclamation-circle-fill"></i>
            </div>
            <div class="stat-value">{{ high_overtime_count }}</div>
            <div class="stat-label">High OT Alerts</div>
            <div class="stat-trend trend-up">
                <i class="bi bi-arrow-up"></i> 3
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-card">
        <div class="filter-header">
            <h5><i class="bi bi-funnel"></i> Filters & Search</h5>
            <button class="filter-toggle" data-bs-toggle="collapse" data-bs-target="#filterContent">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        <div class="collapse show" id="filterContent">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="searchInput">Search Employee</label>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Name or ID..." value="{{ search_term }}">
                </div>
                <div class="filter-group">
                    <label for="crewFilter">Crew</label>
                    <select class="form-select" id="crewFilter">
                        <option value="">All Crews</option>
                        <option value="A" {% if crew_filter == 'A' %}selected{% endif %}>Crew A</option>
                        <option value="B" {% if crew_filter == 'B' %}selected{% endif %}>Crew B</option>
                        <option value="C" {% if crew_filter == 'C' %}selected{% endif %}>Crew C</option>
                        <option value="D" {% if crew_filter == 'D' %}selected{% endif %}>Crew D</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="jobFilter">Position</label>
                    <select class="form-select" id="jobFilter">
                        <option value="">All Positions</option>
                        {% for position in positions %}
                        <option value="{{ position.id }}" {% if position_filter == position.id|string %}selected{% endif %}>
                            {{ position.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="otRangeFilter">OT Range</label>
                    <select class="form-select" id="otRangeFilter">
                        <option value="">All Ranges</option>
                        <option value="0-50" {% if ot_range_filter == '0-50' %}selected{% endif %}>0-50 hours</option>
                        <option value="50-100" {% if ot_range_filter == '50-100' %}selected{% endif %}>50-100 hours</option>
                        <option value="100-150" {% if ot_range_filter == '100-150' %}selected{% endif %}>100-150 hours</option>
                        <option value="150+" {% if ot_range_filter == '150+' %}selected{% endif %}>150+ hours</option>
                    </select>
                </div>
            </div>
            <button class="btn-apply-filters" onclick="applyFilters()">
                <i class="bi bi-check-circle"></i> Apply Filters
            </button>
        </div>
    </div>

    <!-- Multi-Level Sorter -->
    <div class="sorter-card">
        <div class="filter-header">
            <h5><i class="bi bi-sort-alpha-down"></i> Advanced Sorting</h5>
            <button class="filter-toggle" data-bs-toggle="collapse" data-bs-target="#sorterContent">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        <div class="collapse" id="sorterContent">
            <p class="text-muted mb-3">Create multi-level sorting rules (up to 4 levels)</p>
            
            <div id="sorterContainer">
                <!-- Level 1 -->
                <div class="sorter-level" data-level="1">
                    <span class="level-badge">1st</span>
                    <label class="form-label mb-0 me-2">Sort by:</label>
                    <select class="form-select form-select-sm" style="width: auto;" id="sortLevel1">
                        <option value="">-- Select --</option>
                        <option value="crew">Crew</option>
                        <option value="jobtitle">Job Title</option>
                        <option value="seniority">Seniority</option>
                        <option value="overtime">Overtime Hours</option>
                    </select>
                    <div class="sort-direction-toggle">
                        <button class="active" data-direction="asc">
                            <i class="bi bi-sort-up"></i> Ascending
                        </button>
                        <button data-direction="desc">
                            <i class="bi bi-sort-down"></i> Descending
                        </button>
                    </div>
                </div>
                
                <!-- Additional levels will be similar -->
                <div class="sorter-level disabled" data-level="2">
                    <span class="level-badge">2nd</span>
                    <label class="form-label mb-0 me-2">Then by:</label>
                    <select class="form-select form-select-sm" style="width: auto;" id="sortLevel2" disabled>
                        <option value="">-- Select --</option>
                    </select>
                    <div class="sort-direction-toggle">
                        <button class="active" data-direction="asc">
                            <i class="bi bi-sort-up"></i> Ascending
                        </button>
                        <button data-direction="desc">
                            <i class="bi bi-sort-down"></i> Descending
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-primary" onclick="applyMultiLevelSort()">
                    <i class="bi bi-check-circle"></i> Apply Sort
                </button>
                <button class="btn btn-outline-secondary" onclick="resetSort()">
                    <i class="bi bi-x-circle"></i> Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="table-card">
        <div class="table-header">
            <h4>Employee Overtime Details</h4>
            <div class="table-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleView()">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>
            </div>
        </div>

        {% if employees %}
        <div class="table-responsive">
            <table class="overtime-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Employee <i class="bi bi-arrow-down-up"></i></th>
                        <th onclick="sortTable(1)">Crew <i class="bi bi-arrow-down-up"></i></th>
                        <th onclick="sortTable(2)">Position <i class="bi bi-arrow-down-up"></i></th>
                        <th onclick="sortTable(3)">Seniority <i class="bi bi-arrow-down-up"></i></th>
                        <th class="text-center" onclick="sortTable(4)">Current Week <i class="bi bi-arrow-down-up"></i></th>
                        <th class="text-center" onclick="sortTable(5)">13-Week Total <i class="bi bi-arrow-down-up"></i></th>
                        <th class="text-center" onclick="sortTable(6)">Weekly Avg <i class="bi bi-arrow-down-up"></i></th>
                        <th class="text-center">Trend</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in employees %}
                    <tr data-employee-id="{{ employee.id }}">
                        <td>
                            <div class="employee-card">
                                <div class="employee-avatar" style="background: {{ loop.cycle('#11998e', '#667eea', '#f093fb', '#f5576c', '#4facfe') }};">
                                    {{ employee.name[:2].upper() }}
                                </div>
                                <div class="employee-details">
                                    <div class="employee-name">{{ employee.name }}</div>
                                    <div class="employee-id">{{ employee.employee_id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if employee.crew %}
                            <span class="crew-badge crew-{{ employee.crew|lower }}">Crew {{ employee.crew }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ employee.position.name if employee.position else '-' }}</td>
                        <td>
                            {% if employee.years_employed %}
                            <span class="text-muted">{{ employee.years_employed }} yr{{ 's' if employee.years_employed != 1 }}</span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="ot-value {% if employee.current_week_overtime >= 20 %}ot-critical{% elif employee.current_week_overtime >= 16 %}ot-high{% elif employee.current_week_overtime >= 12 %}ot-medium{% else %}ot-low{% endif %}">
                                {{ employee.current_week_overtime }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="ot-value {% if employee.last_13_weeks_overtime > 200 %}ot-critical{% elif employee.last_13_weeks_overtime > 150 %}ot-high{% elif employee.last_13_weeks_overtime > 100 %}ot-medium{% else %}ot-low{% endif %}">
                                {{ employee.last_13_weeks_overtime }}
                            </span>
                        </td>
                        <td class="text-center">
                            <strong>{{ employee.average_weekly_overtime }}</strong>
                        </td>
                        <td class="text-center">
                            {% if employee.overtime_trend == 'increasing' %}
                            <span class="trend-badge up">
                                <i class="bi bi-arrow-up-circle-fill"></i> Rising
                            </span>
                            {% elif employee.overtime_trend == 'decreasing' %}
                            <span class="trend-badge down">
                                <i class="bi bi-arrow-down-circle-fill"></i> Falling
                            </span>
                            {% else %}
                            <span class="trend-badge stable">
                                <i class="bi bi-dash-circle"></i> Stable
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                {% set url_params = request.args.to_dict() %}
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    {% set _ = url_params.update({'page': page - 1}) %}
                    <a class="page-link" href="?{{ url_params | urlencode }}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                
                {% for p in range(1, total_pages + 1) %}
                    {% if p == 1 or p == total_pages or (p > page - 3 and p < page + 3) %}
                        <li class="page-item {% if p == page %}active{% endif %}">
                            {% set _ = url_params.update({'page': p}) %}
                            <a class="page-link" href="?{{ url_params | urlencode }}">{{ p }}</a>
                        </li>
                    {% elif p == page - 3 or p == page + 3 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    {% set _ = url_params.update({'page': page + 1}) %}
                    <a class="page-link" href="?{{ url_params | urlencode }}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h5>No Data Found</h5>
            <p>Try adjusting your filters or <a href="{{ url_for('employee_import.upload_employees') }}">upload employee data</a></p>
        </div>
        {% endif %}
    </div>

    <!-- Export Section -->
    <div class="export-card">
        <div class="export-header">
            <h5>Export & Reports</h5>
            <p>Generate reports with current filters applied</p>
        </div>
        <div class="export-options">
            <div class="export-btn" onclick="exportToExcel()">
                <i class="bi bi-file-earmark-excel"></i>
                <div class="export-btn-label">Excel Report</div>
            </div>
            <div class="export-btn" onclick="generatePDF()">
                <i class="bi bi-file-earmark-pdf"></i>
                <div class="export-btn-label">PDF Summary</div>
            </div>
            <div class="export-btn" onclick="emailReport()">
                <i class="bi bi-envelope-arrow-up"></i>
                <div class="export-btn-label">Email Report</div>
            </div>
            <div class="export-btn" onclick="window.print()">
                <i class="bi bi-printer"></i>
                <div class="export-btn-label">Print View</div>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // Multi-level sorting configuration
    const sortOptions = {
        'crew': 'Crew',
        'jobtitle': 'Job Title',
        'seniority': 'Seniority',
        'overtime': 'Overtime Hours'
    };

    // Initialize multi-level sorter
    document.addEventListener('DOMContentLoaded', function() {
        // Set up sort level handlers
        for (let i = 1; i <= 4; i++) {
            const select = document.getElementById(`sortLevel${i}`);
            if (select) {
                select.addEventListener('change', function() {
                    updateSortOptions(i);
                });
            }
        }

        // Direction toggle buttons
        document.querySelectorAll('.sort-direction-toggle button').forEach(button => {
            button.addEventListener('click', function() {
                const parent = this.closest('.sort-direction-toggle');
                parent.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
            });
        });
    });

    function updateSortOptions(changedLevel) {
        // Enable next level if current has selection
        const currentSelect = document.getElementById(`sortLevel${changedLevel}`);
        if (currentSelect.value && changedLevel < 4) {
            const nextLevel = document.querySelector(`.sorter-level[data-level="${changedLevel + 1}"]`);
            const nextSelect = document.getElementById(`sortLevel${changedLevel + 1}`);
            
            nextLevel.classList.remove('disabled');
            nextSelect.disabled = false;
            
            // Populate options
            nextSelect.innerHTML = '<option value="">-- Select --</option>';
            for (const [value, label] of Object.entries(sortOptions)) {
                // Don't show already selected options
                let alreadySelected = false;
                for (let j = 1; j <= changedLevel; j++) {
                    if (document.getElementById(`sortLevel${j}`).value === value) {
                        alreadySelected = true;
                        break;
                    }
                }
                if (!alreadySelected) {
                    nextSelect.innerHTML += `<option value="${value}">${label}</option>`;
                }
            }
        }
    }

    function applyFilters() {
        const params = new URLSearchParams(window.location.search);
        
        // Get filter values
        const searchTerm = document.getElementById('searchInput').value;
        const selectedCrew = document.getElementById('crewFilter').value;
        const selectedPosition = document.getElementById('jobFilter').value;
        const selectedOTRange = document.getElementById('otRangeFilter').value;
        
        // Update URL parameters
        if (searchTerm) params.set('search', searchTerm);
        else params.delete('search');
        
        if (selectedCrew) params.set('crew', selectedCrew);
        else params.delete('crew');
        
        if (selectedPosition) params.set('position', selectedPosition);
        else params.delete('position');
        
        if (selectedOTRange) params.set('ot_range', selectedOTRange);
        else params.delete('ot_range');
        
        // Reset to page 1
        params.set('page', '1');
        
        // Reload with new parameters
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }

    function applyMultiLevelSort() {
        const params = new URLSearchParams(window.location.search);
        
        // Clear existing sort parameters
        for (let i = 1; i <= 4; i++) {
            params.delete(`sort${i}`);
            params.delete(`dir${i}`);
        }
        
        // Add new sort parameters
        let hasSort = false;
        for (let i = 1; i <= 4; i++) {
            const select = document.getElementById(`sortLevel${i}`);
            if (select && select.value) {
                const directionBtn = document.querySelector(`.sorter-level[data-level="${i}"] .sort-direction-toggle button.active`);
                params.set(`sort${i}`, select.value);
                params.set(`dir${i}`, directionBtn.dataset.direction);
                hasSort = true;
            }
        }
        
        if (!hasSort) {
            alert('Please select at least one sorting criterion');
            return;
        }
        
        params.set('page', '1');
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }

    function resetSort() {
        const params = new URLSearchParams(window.location.search);
        
        // Remove all sort parameters
        for (let i = 1; i <= 4; i++) {
            params.delete(`sort${i}`);
            params.delete(`dir${i}`);
        }
        
        params.set('page', '1');
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }

    function exportToExcel() {
        const params = new URLSearchParams(window.location.search);
        window.location.href = '{{ url_for("employee_import.export_current_overtime") }}?' + params.toString();
    }

    function generatePDF() {
        alert('PDF export functionality coming soon!');
    }

    function emailReport() {
        alert('Email report functionality coming soon!');
    }

    function filterHighOT() {
        document.getElementById('otRangeFilter').value = '150+';
        applyFilters();
    }

    function refreshData() {
        window.location.reload();
    }

    function toggleView() {
        alert('Grid view coming soon!');
    }

    // Add hover effects
    document.querySelectorAll('.overtime-table tbody tr').forEach(row => {
        row.addEventListener('click', function() {
            const employeeId = this.dataset.employeeId;
            // Could open a modal with detailed employee overtime info
            console.log('Clicked employee:', employeeId);
        });
    });
</script>
{% endblock %}
