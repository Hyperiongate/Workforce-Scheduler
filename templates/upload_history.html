{% extends "base.html" %}

{% block title %}Upload History - Workforce Scheduler{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">
        <i class="bi bi-clock-history"></i> Upload History
    </h2>
    
    <div class="card mb-3">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Type</label>
                    <select name="type" class="form-select">
                        <option value="all">All Types</option>
                        <option value="employee" {% if request.args.get('type') == 'employee' %}selected{% endif %}>Employee Data</option>
                        <option value="overtime" {% if request.args.get('type') == 'overtime' %}selected{% endif %}>Overtime History</option>
                        <option value="bulk" {% if request.args.get('type') == 'bulk' %}selected{% endif %}>Bulk Update</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">From Date</label>
                    <input type="date" name="from" class="form-control" value="{{ request.args.get('from', '') }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">To Date</label>
                    <input type="date" name="to" class="form-control" value="{{ request.args.get('to', '') }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary d-block">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date/Time</th>
                    <th>File Name</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Processed</th>
                    <th>Created</th>
                    <th>Updated</th>
                    <th>Duration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for upload in uploads %}
                <tr>
                    <td>{{ upload.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ upload.filename }}</td>
                    <td>
                        <span class="badge bg-secondary">{{ upload.upload_type }}</span>
                    </td>
                    <td>
                        {% if upload.status == 'completed' %}
                            <span class="badge bg-success">{{ upload.status }}</span>
                        {% elif upload.status == 'processing' %}
                            <span class="badge bg-info">{{ upload.status }}</span>
                        {% elif upload.status == 'failed' %}
                            <span class="badge bg-danger">{{ upload.status }}</span>
                        {% else %}
                            <span class="badge bg-warning">{{ upload.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ upload.records_processed or 0 }}</td>
                    <td>{{ upload.records_created or 0 }}</td>
                    <td>{{ upload.records_updated or 0 }}</td>
                    <td>
                        {% if upload.duration %}
                            {{ "%.1f"|format(upload.duration) }}s
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" 
                                    onclick="viewDetails({{ upload.id }})"
                                    title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <a href="{{ url_for('employee_import.download_upload_file', upload_id=upload.id) }}" 
                               class="btn btn-outline-secondary"
                               title="Download Original File">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center text-muted">No uploads found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function viewDetails(uploadId) {
    // Fetch upload details via API
    fetch(`/api/upload-history`)
        .then(response => response.json())
        .then(data => {
            const upload = data.find(u => u.id === uploadId);
            if (upload) {
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <dl class="row">
                        <dt class="col-sm-3">File Name:</dt>
                        <dd class="col-sm-9">${upload.filename}</dd>
                        
                        <dt class="col-sm-3">Upload Type:</dt>
                        <dd class="col-sm-9">${upload.upload_type}</dd>
                        
                        <dt class="col-sm-3">Status:</dt>
                        <dd class="col-sm-9"><span class="badge bg-${upload.status === 'completed' ? 'success' : 'warning'}">${upload.status}</span></dd>
                        
                        <dt class="col-sm-3">Uploaded At:</dt>
                        <dd class="col-sm-9">${new Date(upload.uploaded_at).toLocaleString()}</dd>
                        
                        <dt class="col-sm-3">Uploaded By:</dt>
                        <dd class="col-sm-9">${upload.uploaded_by}</dd>
                        
                        <dt class="col-sm-3">Records Processed:</dt>
                        <dd class="col-sm-9">${upload.records_processed || 0}</dd>
                        
                        <dt class="col-sm-3">Records Created:</dt>
                        <dd class="col-sm-9">${upload.records_created || 0}</dd>
                        
                        <dt class="col-sm-3">Records Updated:</dt>
                        <dd class="col-sm-9">${upload.records_updated || 0}</dd>
                    </dl>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                modal.show();
            }
        })
        .catch(error => {
            console.error('Error fetching details:', error);
        });
}
</script>
{% endblock %}
