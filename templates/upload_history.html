<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-completed_with_errors {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-processing {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        .filter-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .detail-modal .modal-body dt {
            font-weight: 600;
            color: #495057;
        }
        
        .detail-modal .modal-body dd {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    {% extends "base.html" %}
    {% block content %}
    
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h2"><i class="bi bi-clock-history"></i> Upload History</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('supervisor.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Upload History</li>
                    </ol>
                </nav>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-card">
                    <form method="GET" id="filterForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="file_type" class="form-label">File Type</label>
                                <select name="file_type" id="file_type" class="form-select">
                                    <option value="">All Types</option>
                                    <option value="employee_import" {% if request.args.get('file_type') == 'employee_import' %}selected{% endif %}>Employee Import</option>
                                    <option value="overtime_import" {% if request.args.get('file_type') == 'overtime_import' %}selected{% endif %}>Overtime Import</option>
                                    <option value="bulk_update" {% if request.args.get('file_type') == 'bulk_update' %}selected{% endif %}>Bulk Update</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label">Status</label>
                                <select name="status" id="status" class="form-select">
                                    <option value="">All Statuses</option>
                                    <option value="completed" {% if request.args.get('status') == 'completed' %}selected{% endif %}>Completed</option>
                                    <option value="completed_with_errors" {% if request.args.get('status') == 'completed_with_errors' %}selected{% endif %}>Completed with Errors</option>
                                    <option value="failed" {% if request.args.get('status') == 'failed' %}selected{% endif %}>Failed</option>
                                    <option value="processing" {% if request.args.get('status') == 'processing' %}selected{% endif %}>Processing</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" name="start_date" id="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
                            </div>
                            <div class="col-md-2">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" name="end_date" id="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-funnel"></i> Filter
                                    </button>
                                    <a href="{{ url_for('employee_import.upload_history') }}" class="btn btn-secondary">
                                        <i class="bi bi-arrow-counterclockwise"></i> Clear
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Upload History Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Upload Records</h5>
                    </div>
                    <div class="card-body">
                        {% if uploads %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>File Name</th>
                                        <th>Type</th>
                                        <th>Uploaded By</th>
                                        <th>Status</th>
                                        <th>Records</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for upload in uploads %}
                                    <tr onclick="showUploadDetails({{ upload.id }})" style="cursor: pointer;">
                                        <td>{{ upload.upload_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>{{ upload.filename }}</td>
                                        <td>
                                            {% if upload.file_type == 'employee_import' %}
                                                <i class="bi bi-people-fill text-primary"></i> Employee
                                            {% elif upload.file_type == 'overtime_import' %}
                                                <i class="bi bi-clock-history text-success"></i> Overtime
                                            {% elif upload.file_type == 'bulk_update' %}
                                                <i class="bi bi-pencil-square text-warning"></i> Bulk Update
                                            {% else %}
                                                {{ upload.file_type }}
                                            {% endif %}
                                        </td>
                                        <td>{{ upload.uploaded_by.name }}</td>
                                        <td>
                                            <span class="status-badge status-{{ upload.status }}">
                                                {{ upload.status.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if upload.records_processed %}
                                                {{ upload.records_processed }}
                                                {% if upload.records_created %}
                                                    <small class="text-muted">({{ upload.records_created }} new)</small>
                                                {% endif %}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td onclick="event.stopPropagation();">
                                            <button class="btn btn-sm btn-info" onclick="showUploadDetails({{ upload.id }})" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <a href="{{ url_for('employee_import.download_upload_file', upload_id=upload.id) }}" 
                                               class="btn btn-sm btn-secondary" title="Download Original File">
                                                <i class="bi bi-download"></i>
                                            </a>
                                            {% if current_user.is_supervisor %}
                                            <button class="btn btn-sm btn-danger" onclick="deleteUpload({{ upload.id }})" title="Delete Record">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination could go here -->
                        
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
                            <p class="mt-3 text-muted">No upload records found</p>
                            <a href="{{ url_for('employee_import.upload_employees') }}" class="btn btn-primary">
                                <i class="bi bi-upload"></i> Upload Files
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Details Modal -->
    <div class="modal fade detail-modal" id="uploadDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="uploadDetailsContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function showUploadDetails(uploadId) {
        const modal = new bootstrap.Modal(document.getElementById('uploadDetailsModal'));
        modal.show();
        
        // Fetch upload details
        fetch(`{{ url_for('employee_import.get_upload_details', upload_id=0) }}`.replace('0', uploadId))
            .then(response => response.json())
            .then(data => {
                let html = '<dl class="row">';
                
                html += '<dt class="col-sm-4">File Name:</dt>';
                html += `<dd class="col-sm-8">${data.filename}</dd>`;
                
                html += '<dt class="col-sm-4">Upload Date:</dt>';
                html += `<dd class="col-sm-8">${new Date(data.upload_date).toLocaleString()}</dd>`;
                
                html += '<dt class="col-sm-4">Uploaded By:</dt>';
                html += `<dd class="col-sm-8">${data.uploaded_by_name} (${data.uploaded_by_email})</dd>`;
                
                html += '<dt class="col-sm-4">File Type:</dt>';
                html += `<dd class="col-sm-8">${data.file_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</dd>`;
                
                html += '<dt class="col-sm-4">File Size:</dt>';
                html += `<dd class="col-sm-8">${(data.file_size / 1024).toFixed(2)} KB</dd>`;
                
                html += '<dt class="col-sm-4">Status:</dt>';
                html += `<dd class="col-sm-8"><span class="status-badge status-${data.status}">${data.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span></dd>`;
                
                if (data.records_processed) {
                    html += '<dt class="col-sm-4">Records Processed:</dt>';
                    html += `<dd class="col-sm-8">${data.records_processed}</dd>`;
                }
                
                if (data.records_created) {
                    html += '<dt class="col-sm-4">Records Created:</dt>';
                    html += `<dd class="col-sm-8">${data.records_created}</dd>`;
                }
                
                if (data.records_updated) {
                    html += '<dt class="col-sm-4">Records Updated:</dt>';
                    html += `<dd class="col-sm-8">${data.records_updated}</dd>`;
                }
                
                if (data.total_overtime_hours !== undefined) {
                    html += '<dt class="col-sm-4">Total OT Hours:</dt>';
                    html += `<dd class="col-sm-8">${data.total_overtime_hours.toFixed(1)}</dd>`;
                }
                
                if (data.error_details) {
                    html += '<dt class="col-sm-4">Errors:</dt>';
                    html += `<dd class="col-sm-8"><pre class="bg-light p-2" style="max-height: 200px; overflow-y: auto;">${data.error_details}</pre></dd>`;
                }
                
                if (data.notes) {
                    html += '<dt class="col-sm-4">Notes:</dt>';
                    html += `<dd class="col-sm-8">${data.notes}</dd>`;
                }
                
                html += '</dl>';
                
                document.getElementById('uploadDetailsContent').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('uploadDetailsContent').innerHTML = 
                    '<div class="alert alert-danger">Error loading details: ' + error.message + '</div>';
            });
    }
    
    function deleteUpload(uploadId) {
        if (!confirm('Are you sure you want to delete this upload record? This action cannot be undone.')) {
            return;
        }
        
        fetch(`{{ url_for('employee_import.delete_upload', upload_id=0) }}`.replace('0', uploadId), {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error deleting upload: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error deleting upload: ' + error.message);
        });
    }
    </script>
    
    {% endblock %}
</body>
</html>
