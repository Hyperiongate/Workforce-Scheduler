{% extends 'base.html' %}

{% block title %}Upload Employee Data{% endblock %}

{% block content %}
<style>
    .upload-zone {
        border: 3px dashed #28a745;
        border-radius: 15px;
        padding: 80px 40px;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 20px 0;
    }
    
    .upload-zone:hover {
        background-color: #e8f5e9;
        border-color: #1e7e34;
    }
    
    .upload-zone.dragover {
        background-color: #c8e6c9;
        border-color: #388e3c;
        border-style: solid;
        transform: scale(1.02);
    }
    
    .file-selected {
        background-color: #d4edda;
        border: 2px solid #28a745;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
    }
    
    .status-message {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        display: none;
    }
    
    .status-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .status-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .status-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
    
    .processing {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
    }
    
    .summary-card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-upload"></i> Upload Employee Data</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('supervisor.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Upload Employees</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Main Upload Card -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> Employee Data Upload</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> <strong>How it works:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Upload your Excel file with employee data</li>
                            <li>System will automatically update existing employees or add new ones</li>
                            <li>No data will be deleted - only added or updated</li>
                            <li>Position skills will be automatically mapped</li>
                        </ul>
                    </div>
                    
                    <form id="uploadForm" method="POST" enctype="multipart/form-data">
                        <!-- Upload Zone -->
                        <div class="upload-zone" id="uploadZone">
                            <i class="bi bi-file-earmark-excel" style="font-size: 4rem; color: #28a745;"></i>
                            <h3 class="mt-3">Drop Excel File Here</h3>
                            <p class="text-muted mb-3">or click to browse</p>
                            <button type="button" class="btn btn-success btn-lg">
                                <i class="bi bi-folder-open"></i> Select File
                            </button>
                            <input type="file" id="fileInput" name="file" accept=".xlsx,.xls,.csv" style="display: none;">
                        </div>
                        
                        <!-- Selected File Display -->
                        <div id="selectedFile" class="file-selected" style="display: none;">
                            <h5><i class="bi bi-file-earmark-check"></i> File Selected:</h5>
                            <p class="mb-2"><strong id="fileName"></strong></p>
                            <p class="text-muted mb-3" id="fileInfo"></p>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearFile()">
                                <i class="bi bi-x-circle"></i> Remove File
                            </button>
                        </div>
                        
                        <!-- Status Messages -->
                        <div id="statusMessage" class="status-message"></div>
                        
                        <!-- Upload Button -->
                        <div id="uploadButtonDiv" style="display: none;" class="text-center mt-4">
                            <button type="submit" class="btn btn-success btn-lg" id="uploadBtn">
                                <i class="bi bi-cloud-upload"></i> Upload & Process
                            </button>
                        </div>
                        
                        <!-- Hidden field for upload type -->
                        <input type="hidden" name="upload_type" value="employee">
                    </form>
                    
                    <!-- Results Summary -->
                    <div id="resultsSummary" class="summary-card" style="display: none;">
                        <h5><i class="bi bi-check-circle text-success"></i> Upload Complete</h5>
                        <div id="summaryContent"></div>
                        <button type="button" class="btn btn-primary mt-3" onclick="uploadAnother()">
                            <i class="bi bi-arrow-repeat"></i> Upload Another File
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Current Stats -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-graph-up"></i> Current Database Stats
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h3 class="text-primary">{{ total_employees }}</h3>
                            <p class="text-muted">Total Employees</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-success">{{ crew_distribution.A + crew_distribution.B + crew_distribution.C + crew_distribution.D }}</h3>
                            <p class="text-muted">Assigned to Crews</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-warning">{{ crew_distribution.Unassigned }}</h3>
                            <p class="text-muted">Unassigned</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-info">{{ stats.employees_without_ot }}</h3>
                            <p class="text-muted">Missing OT Data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Instructions -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-question-circle"></i> File Format Guide
                </div>
                <div class="card-body">
                    <h6>Required Columns:</h6>
                    <ul class="small">
                        <li><strong>Last Name</strong> - Employee's last name</li>
                        <li><strong>First Name</strong> - Employee's first name</li>
                        <li><strong>Employee ID</strong> - Unique identifier</li>
                        <li><strong>Date of Hire</strong> - Employment start date</li>
                        <li><strong>Total Overtime</strong> - OT hours (last 3 months)</li>
                        <li><strong>Crew Assigned</strong> - A, B, C, or D</li>
                        <li><strong>Current Job Position</strong> - Current role</li>
                    </ul>
                    
                    <h6 class="mt-3">Position Columns:</h6>
                    <p class="small">
                        After the required columns, include columns for each position in your department:
                    </p>
                    <ul class="small">
                        <li>Mark with <strong>"current"</strong> for employee's current position</li>
                        <li>Mark with <strong>"yes"</strong> for qualified positions</li>
                        <li>Leave blank if not qualified</li>
                    </ul>
                    
                    <div class="alert alert-warning mt-3">
                        <small>
                            <i class="bi bi-lightbulb"></i> The system will automatically detect and map all position columns.
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-link-45deg"></i> Quick Links
                </div>
                <div class="card-body">
                    <a href="{{ url_for('employee_import.export_current_employees') }}" class="btn btn-outline-success btn-sm mb-2 w-100">
                        <i class="bi bi-download"></i> Export Current Data
                    </a>
                    <a href="{{ url_for('employee_import.upload_history') }}" class="btn btn-outline-secondary btn-sm mb-2 w-100">
                        <i class="bi bi-clock-history"></i> Upload History
                    </a>
                    <a href="{{ url_for('main.overtime_management') }}" class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-clock"></i> View Overtime
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const selectedFile = document.getElementById('selectedFile');
    const fileName = document.getElementById('fileName');
    const fileInfo = document.getElementById('fileInfo');
    const uploadButtonDiv = document.getElementById('uploadButtonDiv');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusMessage = document.getElementById('statusMessage');
    const resultsSummary = document.getElementById('resultsSummary');
    const summaryContent = document.getElementById('summaryContent');
    const uploadForm = document.getElementById('uploadForm');
    
    // Click to upload
    uploadZone.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
    
    // File selection
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    function handleFileSelect(file) {
        if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
            showStatus('Please select an Excel or CSV file', 'error');
            return;
        }
        
        fileName.textContent = file.name;
        fileInfo.textContent = `Size: ${(file.size / 1024).toFixed(1)} KB`;
        
        uploadZone.style.display = 'none';
        selectedFile.style.display = 'block';
        uploadButtonDiv.style.display = 'block';
        statusMessage.style.display = 'none';
    }
    
    function clearFile() {
        fileInput.value = '';
        uploadZone.style.display = 'block';
        selectedFile.style.display = 'none';
        uploadButtonDiv.style.display = 'none';
        statusMessage.style.display = 'none';
    }
    
    function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message status-' + type;
        statusMessage.style.display = 'block';
    }
    
    // Form submission
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!fileInput.files[0]) {
            showStatus('Please select a file', 'error');
            return;
        }
        
        // Disable button and show processing
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner"></span> Processing...';
        showStatus('Uploading and processing file... This may take a moment.', 'info');
        
        // Submit form
        const formData = new FormData(uploadForm);
        
        try {
            const response = await fetch('{{ url_for("employee_import.upload_employees_post") }}', {
                method: 'POST',
                body: formData
            });
            
            if (response.redirected) {
                // Follow the redirect
                window.location.href = response.url;
            } else {
                // Handle response
                const text = await response.text();
                if (text.includes('success')) {
                    showUploadSuccess();
                } else {
                    showStatus('Upload completed. Check the page for any messages.', 'info');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }
        } catch (error) {
            showStatus('Error uploading file: ' + error.message, 'error');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Upload & Process';
        }
    });
    
    function showUploadSuccess() {
        uploadZone.style.display = 'none';
        selectedFile.style.display = 'none';
        uploadButtonDiv.style.display = 'none';
        statusMessage.style.display = 'none';
        
        resultsSummary.style.display = 'block';
        summaryContent.innerHTML = `
            <p class="text-success"><i class="bi bi-check-circle"></i> File processed successfully!</p>
            <p>The system has automatically:</p>
            <ul>
                <li>Updated existing employees with new information</li>
                <li>Added any new employees found in the file</li>
                <li>Mapped all position qualifications</li>
            </ul>
            <p class="mb-0">No existing data was deleted.</p>
        `;
    }
    
    function uploadAnother() {
        window.location.reload();
    }
</script>
{% endblock %}
