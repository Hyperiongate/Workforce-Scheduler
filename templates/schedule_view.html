{% extends "base.html" %}

{% block title %}Schedule View - Workforce Scheduler{% endblock %}

{% block extra_css %}
<style>
    .schedule-grid {
        font-size: 0.85rem;
    }
    
    .crew-a { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
    .crew-b { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
    .crew-c { background-color: #fff3e0; border-left: 4px solid #ff9800; }
    .crew-d { background-color: #fce4ec; border-left: 4px solid #e91e63; }
    
    .shift-day { background-color: #fff8e1; }
    .shift-night { background-color: #e8eaf6; }
    .shift-evening { background-color: #f3e5f5; }
    
    .schedule-card {
        margin-bottom: 2px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    .date-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        writing-mode: vertical-rl;
        text-orientation: mixed;
    }
    
    .crew-header {
        background: #f8f9fa;
        font-weight: bold;
        text-align: center;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .schedule-cell {
        min-height: 120px;
        vertical-align: top;
        border: 1px solid #dee2e6;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .filter-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .employee-name {
        font-weight: 500;
        color: #495057;
    }
    
    .position-name {
        color: #6c757d;
        font-size: 0.75rem;
    }
    
    .shift-time {
        color: #28a745;
        font-size: 0.7rem;
    }
    
    .hours-badge {
        font-size: 0.7rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-calendar3"></i> Schedule View</h2>
                <div>
                    <a href="{{ url_for('pitman_preview') }}" class="btn btn-success me-2">
                        <i class="bi bi-plus-circle"></i> Generate New Schedule
                    </a>
                    <a href="{{ url_for('supervisor.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section">
                <form method="GET" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Start Date:</label>
                        <input type="date" name="start_date" class="form-control" 
                               value="{{ start_date.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">End Date:</label>
                        <input type="date" name="end_date" class="form-control" 
                               value="{{ end_date.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Update View
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if schedule_grid %}
    <!-- Schedule Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h5>Total Days</h5>
                    <h2>{{ date_range|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h5>Total Shifts</h5>
                    <h2>{{ schedule_grid.values()|map('values')|map('map', 'length')|map('sum')|sum }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h5>Date Range</h5>
                    <h6>{{ start_date.strftime('%m/%d') }} - {{ end_date.strftime('%m/%d') }}</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h5>Pattern Type</h5>
                    <h6>Pitman 2-2-3</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Grid -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-week"></i> Schedule Grid
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0 schedule-grid">
                            <thead>
                                <tr>
                                    <th class="crew-header" style="width: 80px;">Crew</th>
                                    {% for date_str in date_range %}
                                    {% set date_obj = date_str|strptime('%Y-%m-%d') %}
                                    <th class="date-header text-center" style="width: 150px;">
                                        <div class="p-2">
                                            <div>{{ date_obj.strftime('%a') }}</div>
                                            <div>{{ date_obj.strftime('%m/%d') }}</div>
                                        </div>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for crew in ['A', 'B', 'C', 'D'] %}
                                <tr>
                                    <td class="crew-header crew-{{ crew|lower }}">
                                        <strong>Crew {{ crew }}</strong>
                                    </td>
                                    {% for date_str in date_range %}
                                    <td class="schedule-cell">
                                        {% if date_str in schedule_grid and crew in schedule_grid[date_str] %}
                                            {% for schedule in schedule_grid[date_str][crew] %}
                                            <div class="schedule-card shift-{{ schedule.shift_type }}">
                                                <div class="employee-name">{{ schedule.employee.name }}</div>
                                                <div class="position-name">{{ schedule.employee.position.name if schedule.employee.position else 'No Position' }}</div>
                                                <div class="shift-time">
                                                    {{ schedule.start_time.strftime('%H:%M') }} - {{ schedule.end_time.strftime('%H:%M') if schedule.end_time else 'N/A' }}
                                                </div>
                                                <span class="badge bg-secondary hours-badge">{{ schedule.hours }}h</span>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="text-muted text-center">
                                                <small>Off</small>
                                            </div>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Legend</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Crews:</h6>
                            <div class="d-flex flex-wrap">
                                <span class="badge me-2 mb-2 p-2 crew-a">Crew A</span>
                                <span class="badge me-2 mb-2 p-2 crew-b">Crew B</span>
                                <span class="badge me-2 mb-2 p-2 crew-c">Crew C</span>
                                <span class="badge me-2 mb-2 p-2 crew-d">Crew D</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Shifts:</h6>
                            <div class="d-flex flex-wrap">
                                <span class="badge me-2 mb-2 p-2 shift-
