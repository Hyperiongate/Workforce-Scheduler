{% extends "base.html" %}

{% block title %}Schedule View - Workforce Scheduler{% endblock %}

{% block extra_css %}
<style>
    .schedule-grid {
        font-size: 0.85rem;
    }
    
    .crew-a { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
    .crew-b { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
    .crew-c { background-color: #fff3e0; border-left: 4px solid #ff9800; }
    .crew-d { background-color: #fce4ec; border-left: 4px solid #e91e63; }
    
    .shift-day { background-color: #fff8e1; }
    .shift-night { background-color: #e8eaf6; }
    .shift-evening { background-color: #f3e5f5; }
    
    .schedule-card {
        margin-bottom: 2px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    .date-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        writing-mode: vertical-rl;
        text-orientation: mixed;
    }
    
    .crew-header {
        background: #f8f9fa;
        font-weight: bold;
        text-align: center;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .schedule-cell {
        min-height: 120px;
        vertical-align: top;
        border: 1px solid #dee2e6;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .filter-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .employee-name {
        font-weight: 500;
        color: #495057;
    }
    
    .position-name {
        color: #6c757d;
        font-size: 0.75rem;
    }
    
    .shift-time {
        color: #28a745;
        font-size: 0.7rem;
    }
    
    .hours-badge {
        font-size: 0.7rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-calendar3"></i> Schedule View</h2>
                <div>
                    <a href="{{ url_for('pitman_preview') }}" class="btn btn-success me-2">
                        <i class="bi bi-plus-circle"></i> Generate New Schedule
                    </a>
                    <a href="{{ url_for('supervisor.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section">
                <form method="GET" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Start Date:</label>
                        <input type="date" name="start_date" class="form-control" 
                               value="{{ start_date.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">End Date:</label>
                        <input type="date" name="end_date" class="form-control" 
                               value="{{ end_date.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Update View
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if schedule_grid %}
    <!-- Schedule Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h5>Total Days</h5>
                    <h2>{{ date_range|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h5>Total Shifts</h5>
                    <h2>{{ schedule_grid.values()|map('values')|map('map', 'length')|map('sum')|sum }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h5>Date Range</h5>
                    <h6>{{ start_date.strftime('%m/%d') }} - {{ end_date.strftime('%m/%d') }}</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h5>Pattern Type</h5>
                    <h6>Pitman 2-2-3</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Grid -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-week"></i> Schedule Grid
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0 schedule-grid">
                            <thead>
                                <tr>
                                    <th class="crew-header" style="width: 80px;">Crew</th>
                                    {% for date_str in date_range %}
                                    {% set date_obj = date_str|strptime('%Y-%m-%d') %}
                                    <th class="date-header text-center" style="width: 150px;">
                                        <div class="p-2">
                                            <div>{{ date_obj.strftime('%a') }}</div>
                                            <div>{{ date_obj.strftime('%m/%d') }}</div>
                                        </div>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for crew in ['A', 'B', 'C', 'D'] %}
                                <tr>
                                    <td class="crew-header crew-{{ crew|lower }}">
                                        <strong>Crew {{ crew }}</strong>
                                    </td>
                                    {% for date_str in date_range %}
                                    <td class="schedule-cell">
                                        {% if date_str in schedule_grid and crew in schedule_grid[date_str] %}
                                            {% for schedule in schedule_grid[date_str][crew] %}
                                            <div class="schedule-card shift-{{ schedule.shift_type }}">
                                                <div class="employee-name">{{ schedule.employee.name }}</div>
                                                <div class="position-name">{{ schedule.employee.position.name if schedule.employee.position else 'No Position' }}</div>
                                                <div class="shift-time">
                                                    {{ schedule.start_time.strftime('%H:%M') }} - {{ schedule.end_time.strftime('%H:%M') if schedule.end_time else 'N/A' }}
                                                </div>
                                                <span class="badge bg-secondary hours-badge">{{ schedule.hours }}h</span>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="text-muted text-center">
                                                <small>Off</small>
                                            </div>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Legend</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Crews:</h6>
                            <div class="d-flex flex-wrap">
                                <span class="badge me-2 mb-2 p-2 crew-a">Crew A</span>
                                <span class="badge me-2 mb-2 p-2 crew-b">Crew B</span>
                                <span class="badge me-2 mb-2 p-2 crew-c">Crew C</span>
                                <span class="badge me-2 mb-2 p-2 crew-d">Crew D</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Shifts:</h6>
                            <div class="d-flex flex-wrap">
                                <span class="badge me-2 mb-2 p-2 shift-day">Day Shift (06:00-18:00)</span>
                                <span class="badge me-2 mb-2 p-2 shift-night">Night Shift (18:00-06:00)</span>
                                <span class="badge me-2 mb-2 p-2 shift-evening">Evening Shift (15:00-23:00)</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <small class="text-muted">
                                <strong>Pitman Pattern:</strong> Each crew works 7 days out of every 14 days. 
                                Pattern: Work 2 → Off 2 → Work 3 → Off 2 → Work 2 → Off 3 (repeats)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('view_schedule', start_date=(start_date - timedelta(days=14)).strftime('%Y-%m-%d'), end_date=(end_date - timedelta(days=14)).strftime('%Y-%m-%d')) }}" 
                           class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left"></i> Previous 2 Weeks
                        </a>
                        <a href="{{ url_for('view_schedule', start_date=date.today().strftime('%Y-%m-%d'), end_date=(date.today() + timedelta(days=13)).strftime('%Y-%m-%d')) }}" 
                           class="btn btn-outline-success">
                            <i class="bi bi-calendar-today"></i> Current Period
                        </a>
                        <a href="{{ url_for('view_schedule', start_date=(start_date + timedelta(days=14)).strftime('%Y-%m-%d'), end_date=(end_date + timedelta(days=14)).strftime('%Y-%m-%d')) }}" 
                           class="btn btn-outline-primary">
                            <i class="bi bi-arrow-right"></i> Next 2 Weeks
                        </a>
                    </div>
                    
                    <div class="btn-group ms-3" role="group">
                        <button class="btn btn-outline-info" onclick="exportSchedule()">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <button class="btn btn-outline-secondary" onclick="printSchedule()">
                            <i class="bi bi-printer"></i> Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Schedule Data -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-calendar-x display-1 text-muted"></i>
                <h4 class="mt-3">No Schedules Found</h4>
                <p class="mb-4">There are no schedules for the selected date range.</p>
                <a href="{{ url_for('pitman_preview') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle"></i> Generate Pitman Schedule
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function exportSchedule() {
    // Simple CSV export functionality
    const scheduleData = [];
    
    // Add headers
    scheduleData.push(['Date', 'Employee', 'Crew', 'Shift Type', 'Start Time', 'End Time', 'Hours', 'Position']);
    
    // Extract data from table
    const table = document.querySelector('.schedule-grid');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach((row, crewIndex) => {
        const crew = ['A', 'B', 'C', 'D'][crewIndex];
        const cells = row.querySelectorAll('.schedule-cell');
        
        cells.forEach((cell, dateIndex) => {
            const scheduleCards = cell.querySelectorAll('.schedule-card');
            const dateStr = '{{ date_range[' + dateIndex + '] if date_range and ' + dateIndex + ' < date_range|length else "" }}';
            
            scheduleCards.forEach(card => {
                const employeeName = card.querySelector('.employee-name')?.textContent || '';
                const positionName = card.querySelector('.position-name')?.textContent || '';
                const shiftTime = card.querySelector('.shift-time')?.textContent || '';
                const hours = card.querySelector('.hours-badge')?.textContent || '';
                const shiftType = card.classList.contains('shift-day') ? 'Day' : 
                                 card.classList.contains('shift-night') ? 'Night' : 'Evening';
                
                const [startTime, endTime] = shiftTime.split(' - ');
                
                scheduleData.push([
                    dateStr,
                    employeeName,
                    crew,
                    shiftType,
                    startTime || '',
                    endTime || '',
                    hours,
                    positionName
                ]);
            });
        });
    });
    
    // Create CSV content
    const csvContent = scheduleData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `pitman_schedule_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function printSchedule() {
    // Create print-friendly version
    const printContent = document.querySelector('.container-fluid').cloneNode(true);
    
    // Remove buttons and interactive elements
    const buttonsToRemove = printContent.querySelectorAll('.btn, .filter-section, .card:last-child');
    buttonsToRemove.forEach(btn => btn.remove());
    
    // Open print window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Pitman Schedule</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-size: 12px; }
                .schedule-grid { font-size: 10px; }
                .crew-a { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
                .crew-b { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
                .crew-c { background-color: #fff3e0; border-left: 4px solid #ff9800; }
                .crew-d { background-color: #fce4ec; border-left: 4px solid #e91e63; }
                .shift-day { background-color: #fff8e1; }
                .shift-night { background-color: #e8eaf6; }
                .schedule-card { margin-bottom: 2px; padding: 2px 4px; border-radius: 2px; }
                @media print { 
                    .container-fluid { max-width: none !important; }
                    .schedule-grid { font-size: 8px; }
                }
            </style>
        </head>
        <body>
            ${printContent.outerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Add date navigation with keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            // Navigate to previous period
            window.location.href = "{{ url_for('view_schedule', start_date=(start_date - timedelta(days=14)).strftime('%Y-%m-%d'), end_date=(end_date - timedelta(days=14)).strftime('%Y-%m-%d')) if start_date and end_date else '#' }}";
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            // Navigate to next period
            window.location.href = "{{ url_for('view_schedule', start_date=(start_date + timedelta(days=14)).strftime('%Y-%m-%d'), end_date=(end_date + timedelta(days=14)).strftime('%Y-%m-%d')) if start_date and end_date else '#' }}";
        }
    }
});

// Add tooltips for schedule cards
document.addEventListener('DOMContentLoaded', function() {
    const scheduleCards = document.querySelectorAll('.schedule-card');
    scheduleCards.forEach(card => {
        const employee = card.querySelector('.employee-name')?.textContent;
        const position = card.querySelector('.position-name')?.textContent;
        const time = card.querySelector('.shift-time')?.textContent;
        const hours = card.querySelector('.hours-badge')?.textContent;
        
        if (employee) {
            card.title = `${employee}\n${position}\n${time}\n${hours}`;
        }
    });
});
</script>
{% endblock %}
