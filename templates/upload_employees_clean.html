{% extends 'base.html' %}

{% block title %}Upload Employee Data{% endblock %}

{% block content %}
<style>
    .upload-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .upload-box {
        border: 3px dashed #6c757d;
        border-radius: 10px;
        padding: 60px;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .upload-box:hover {
        border-color: #007bff;
        background-color: #e9ecef;
    }
    
    .upload-box.dragover {
        background-color: #d1ecf1;
        border-color: #007bff;
        border-style: solid;
    }
    
    .file-ready {
        background-color: #d4edda;
        border: 2px solid #28a745;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
    }
    
    .summary-stat {
        text-align: center;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .summary-stat h3 {
        margin: 0;
        color: #007bff;
        font-size: 2.5rem;
    }
    
    .summary-stat p {
        margin: 5px 0 0 0;
        color: #6c757d;
    }
    
    .crew-table {
        margin-top: 20px;
    }
    
    .crew-table th {
        background-color: #007bff;
        color: white;
    }
    
    .btn-upload {
        font-size: 1.2rem;
        padding: 12px 40px;
    }
</style>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>Upload Employee Data</h2>
            <p class="text-muted">Upload your Excel file to update employee information</p>
        </div>
    </div>
    
    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="summary-stat">
                <h3>{{ total_employees }}</h3>
                <p>Total Employees</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-stat">
                <h3>{{ crew_distribution.A }}</h3>
                <p>Crew A</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-stat">
                <h3>{{ crew_distribution.B }}</h3>
                <p>Crew B</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-stat">
                <h3>{{ crew_distribution.C }}</h3>
                <p>Crew C</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-stat">
                <h3>{{ crew_distribution.D }}</h3>
                <p>Crew D</p>
            </div>
        </div>
    </div>
    
    <!-- Main Upload Section -->
    <div class="upload-container">
        <div class="card">
            <div class="card-body p-4">
                <!-- Template Download -->
                <div class="text-center mb-4">
                    <p class="mb-3">First, download the template to ensure your data is formatted correctly:</p>
                    <a href="{{ url_for('employee_import.download_employee_template') }}" class="btn btn-outline-primary">
                        <i class="bi bi-download"></i> Download Employee Template
                    </a>
                </div>
                
                <hr class="my-4">
                
                <!-- Upload Form -->
                <form id="uploadForm" method="POST" enctype="multipart/form-data">
                    <div class="upload-box" id="uploadBox">
                        <i class="bi bi-cloud-arrow-up" style="font-size: 3rem; color: #6c757d;"></i>
                        <h4 class="mt-3 mb-3">Drop Excel File Here</h4>
                        <p class="text-muted mb-4">or click to browse</p>
                        <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" style="display: none;">
                    </div>
                    
                    <!-- File Selected Display -->
                    <div id="fileSelected" class="file-ready" style="display: none;">
                        <i class="bi bi-file-earmark-check" style="font-size: 3rem; color: #28a745;"></i>
                        <h4 class="mt-3" id="fileName"></h4>
                        <button type="submit" class="btn btn-success btn-upload mt-3">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                        <button type="button" class="btn btn-link" onclick="resetUpload()">Choose Different File</button>
                    </div>
                    
                    <input type="hidden" name="upload_type" value="employee">
                </form>
            </div>
        </div>
    </div>
    
    <!-- Crew Distribution Table -->
    <div class="row mt-5">
        <div class="col">
            <h4>Current Crew Distribution</h4>
            <div class="table-responsive crew-table">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Crew</th>
                            <th>Employee Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set total = crew_distribution.A + crew_distribution.B + crew_distribution.C + crew_distribution.D %}
                        <tr>
                            <td><strong>Crew A</strong></td>
                            <td>{{ crew_distribution.A }}</td>
                            <td>{{ "%.1f"|format((crew_distribution.A / total * 100) if total > 0 else 0) }}%</td>
                        </tr>
                        <tr>
                            <td><strong>Crew B</strong></td>
                            <td>{{ crew_distribution.B }}</td>
                            <td>{{ "%.1f"|format((crew_distribution.B / total * 100) if total > 0 else 0) }}%</td>
                        </tr>
                        <tr>
                            <td><strong>Crew C</strong></td>
                            <td>{{ crew_distribution.C }}</td>
                            <td>{{ "%.1f"|format((crew_distribution.C / total * 100) if total > 0 else 0) }}%</td>
                        </tr>
                        <tr>
                            <td><strong>Crew D</strong></td>
                            <td>{{ crew_distribution.D }}</td>
                            <td>{{ "%.1f"|format((crew_distribution.D / total * 100) if total > 0 else 0) }}%</td>
                        </tr>
                        {% if crew_distribution.Unassigned > 0 %}
                        <tr>
                            <td><strong>Unassigned</strong></td>
                            <td>{{ crew_distribution.Unassigned }}</td>
                            <td>-</td>
                        </tr>
                        {% endif %}
                    </tbody>
                    <tfoot>
                        <tr class="table-info">
                            <th>Total</th>
                            <th>{{ total_employees }}</th>
                            <th>100%</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const uploadBox = document.getElementById('uploadBox');
    const fileInput = document.getElementById('fileInput');
    const fileSelected = document.getElementById('fileSelected');
    const fileName = document.getElementById('fileName');
    
    // Click to upload
    uploadBox.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Drag and drop
    uploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadBox.classList.add('dragover');
    });
    
    uploadBox.addEventListener('dragleave', () => {
        uploadBox.classList.remove('dragover');
    });
    
    uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadBox.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            selectFile(files[0]);
        }
    });
    
    // File selection
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            selectFile(e.target.files[0]);
        }
    });
    
    function selectFile(file) {
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            alert('Please select an Excel file (.xlsx or .xls)');
            return;
        }
        
        fileName.textContent = file.name;
        uploadBox.style.display = 'none';
        fileSelected.style.display = 'block';
    }
    
    function resetUpload() {
        fileInput.value = '';
        uploadBox.style.display = 'block';
        fileSelected.style.display = 'none';
    }
</script>
{% endblock %}
