{% extends "base.html" %}

{% block title %}Upload Overtime History - Workforce Scheduler{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .upload-header {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .upload-zone {
        border: 3px dashed #11998e;
        border-radius: 10px;
        padding: 3rem;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        min-height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .upload-zone:hover {
        background: #e8f5f2;
        border-color: #0e8071;
    }
    
    .upload-zone.dragover {
        background: #d4edda;
        border-color: #28a745;
        transform: scale(1.02);
    }
    
    .stats-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-bottom: 1rem;
        transition: transform 0.2s;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .stats-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #11998e;
    }
    
    .ot-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        border-radius: 4px;
    }
    
    .ot-danger {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        padding: 1rem;
        border-radius: 4px;
    }
    
    .file-info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .action-buttons {
        display: none;
        margin-top: 2rem;
        gap: 1rem;
    }
    
    .validation-results {
        display: none;
        margin-top: 2rem;
    }
    
    .validation-success {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #c3e6cb;
    }
    
    .validation-error {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
    }
    
    #importBtn {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="upload-header">
        <h1><i class="bi bi-clock-history"></i> Upload Overtime History</h1>
        <p class="mb-0">Import 13-week overtime history for all employees</p>
    </div>
    
    <div class="row">
        <!-- Main Upload Section -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title mb-4">Upload Overtime Data</h4>
                    
                    <form method="POST" enctype="multipart/form-data" id="uploadForm" action="{{ url_for('employee_import.upload_employees_post') }}">
                        <!-- Hidden input for upload type -->
                        <input type="hidden" name="upload_type" value="overtime">
                        
                        <!-- File Upload Zone -->
                        <div class="upload-zone" id="uploadZone">
                            <i class="bi bi-cloud-arrow-up" style="font-size: 3rem; color: #11998e;"></i>
                            <h4 class="mt-3">Drag & Drop Excel File Here</h4>
                            <p class="text-muted">or click to browse</p>
                            <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" style="display: none;">
                        </div>
                        
                        <!-- Selected File Display -->
                        <div id="selectedFile" class="file-info" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-file-earmark-excel text-success"></i>
                                    <strong>Selected:</strong> <span id="fileName"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFileSelection()">
                                    <i class="bi bi-x"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Options Section -->
                        <div id="optionsSection" style="display: none;" class="mt-4">
                            <h5>Import Options</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mode" id="replaceMode" value="replace" checked>
                                <label class="form-check-label" for="replaceMode">
                                    <strong>Replace All</strong> - Clear existing overtime data and import new
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="mode" id="appendMode" value="append">
                                <label class="form-check-label" for="appendMode">
                                    <strong>Update/Append</strong> - Update existing records or add new ones
                                </label>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div id="actionButtons" class="action-buttons d-flex">
                            <button type="button" class="btn btn-secondary" onclick="validateFile()">
                                <i class="bi bi-check-circle"></i> Validate Only
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-cloud-upload"></i> Upload & Import
                            </button>
                        </div>
                        
                        <!-- Validation Results -->
                        <div id="validationResults" class="validation-results"></div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Statistics Card -->
            <div class="card stats-card">
                <div class="card-body">
                    <h5 class="card-title">Current Statistics</h5>
                    <div class="text-center mb-3">
                        <div class="stats-value">{{ stats.total_ot_hours|round|int }}</div>
                        <p class="text-muted mb-0">Total OT Hours</p>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">{{ stats.employees_with_ot }}</h4>
                            <small class="text-muted">Employees with OT</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">{{ stats.employees_without_ot|default(0) }}</h4>
                            <small class="text-muted">Missing OT Data</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Instructions Card -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> File Format</h5>
                </div>
                <div class="card-body">
                    <p>Your Excel file should contain:</p>
                    <ul class="small">
                        <li><strong>Employee ID</strong> - Must match existing employees</li>
                        <li><strong>Week 1</strong> through <strong>Week 13</strong> - Overtime hours for each week</li>
                    </ul>
                    
                    <a href="{{ url_for('employee_import.download_overtime_template') }}" class="btn btn-primary w-100">
                        <i class="bi bi-download"></i> Download Template
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// File upload handling
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const selectedFile = document.getElementById('selectedFile');
const fileName = document.getElementById('fileName');
const optionsSection = document.getElementById('optionsSection');
const actionButtons = document.getElementById('actionButtons');

// Click to select file
uploadZone.addEventListener('click', () => {
    fileInput.click();
});

// Drag and drop
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

// File input change
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
        alert('Please select an Excel file (.xlsx or .xls)');
        return;
    }
    
    // Set the file in the input
    const dt = new DataTransfer();
    dt.items.add(file);
    fileInput.files = dt.files;
    
    // Update UI
    fileName.textContent = file.name;
    selectedFile.style.display = 'block';
    optionsSection.style.display = 'block';
    actionButtons.style.display = 'flex';
}

function clearFileSelection() {
    fileInput.value = '';
    selectedFile.style.display = 'none';
    optionsSection.style.display = 'none';
    actionButtons.style.display = 'none';
    document.getElementById('validationResults').innerHTML = '';
    document.getElementById('validationResults').style.display = 'none';
}

function validateFile() {
    if (!fileInput.files[0]) {
        alert('Please select a file first');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('uploadType', 'overtime');
    
    // Show loading
    const resultsDiv = document.getElementById('validationResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Validating...</span></div><p class="mt-2">Validating file...</p></div>';
    
    // Make AJAX request to validate
    fetch('{{ url_for("employee_import.validate_upload") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultsDiv.innerHTML = `
                <div class="validation-success">
                    <i class="bi bi-check-circle-fill"></i> Validation Successful!
                    <p class="mb-0 mt-2">Found ${data.employee_count || 0} employees with overtime data.</p>
                </div>
            `;
        } else {
            let errorHtml = `
                <div class="validation-error">
                    <i class="bi bi-x-circle-fill"></i> Validation Failed
                    <p class="mt-2 mb-1">${data.error || 'Unknown error'}</p>
            `;
            
            if (data.errors && data.errors.length > 0) {
                errorHtml += '<ul class="mb-0">';
                data.errors.forEach(error => {
                    errorHtml += `<li>${error}</li>`;
                });
                errorHtml += '</ul>';
            }
            
            errorHtml += '</div>';
            resultsDiv.innerHTML = errorHtml;
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `
            <div class="validation-error">
                <i class="bi bi-x-circle-fill"></i> Error validating file
                <p class="mb-0 mt-2">${error.message}</p>
            </div>
        `;
    });
}
</script>
{% endblock %}
