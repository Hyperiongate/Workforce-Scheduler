{% extends "base.html" %}
{% block title %}{{ pattern_config.name }} Schedule Pattern{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2">{{ pattern_config.name }} Schedule Pattern</h1>
                    <p class="text-muted">Learn about this pattern and preview how it works</p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('schedule.schedule_select') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Patterns
                    </a>
                    <button class="btn btn-primary" id="createScheduleBtn">
                        <i class="bi bi-calendar-plus"></i> Create This Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Pattern Information -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-info-circle"></i> Pattern Details</h5>
                </div>
                <div class="card-body">
                    <div class="pattern-info" id="patternInfo">
                        <!-- Pattern details will be populated by JavaScript -->
                    </div>
                    
                    <hr>
                    
                    <div class="crew-requirements">
                        <h6>Crew Requirements</h6>
                        <div class="row">
                            {% for crew in ['A', 'B', 'C', 'D'] %}
                            <div class="col-6 mb-2">
                                <div class="crew-stat">
                                    <strong>Crew {{ crew }}:</strong> {{ crew_stats[crew]['count'] }} employees
                                    {% if crew_stats[crew]['count'] == 0 %}
                                        <span class="badge bg-warning ms-1">Empty</span>
                                    {% elif crew_stats[crew]['count'] < 3 %}
                                        <span class="badge bg-info ms-1">Low</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if unassigned_employees %}
                        <div class="alert alert-info mt-2">
                            <small><i class="bi bi-exclamation-triangle"></i> {{ unassigned_employees|length }} unassigned employees need crew placement</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Pattern Configuration -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-gear"></i> Configuration Options</h5>
                </div>
                <div class="card-body">
                    <form id="patternConfig">
                        <div class="mb-3">
                            <label for="shiftRotation" class="form-label">Rotation Type</label>
                            <select class="form-select" id="shiftRotation" name="rotation_type">
                                {% if pattern_config.allows_fixed %}
                                <option value="fixed">Fixed Crews (No Rotation)</option>
                                {% endif %}
                                {% if pattern_config.allows_rotating %}
                                {% for option in pattern_config.rotation_options %}
                                <option value="{{ option.lower().replace(' ', '_') }}">{{ option }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="start_date" 
                                   value="{{ (datetime.now().date() + timedelta(days=7)).strftime('%Y-%m-%d') }}">
                        </div>

                        <div class="mb-3">
                            <label for="shiftTimes" class="form-label">Shift Times</label>
                            <div class="row">
                                {% if pattern_config.shift_hours == 12 %}
                                <div class="col-6">
                                    <label class="form-label small">Day Start</label>
                                    <input type="time" class="form-control" value="06:00" id="dayStart">
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Night Start</label>
                                    <input type="time" class="form-control" value="18:00" id="nightStart">
                                </div>
                                {% else %}
                                <div class="col-4">
                                    <label class="form-label small">Day</label>
                                    <input type="time" class="form-control" value="07:00" id="dayStart">
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">Evening</label>
                                    <input type="time" class="form-control" value="15:00" id="eveningStart">
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">Night</label>
                                    <input type="time" class="form-control" value="23:00" id="nightStart">
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Pattern Preview -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-calendar-week"></i> 4-Week Pattern Preview</h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshPreview">
                        <i class="bi bi-arrow-clockwise"></i> Update Preview
                    </button>
                </div>
                <div class="card-body">
                    <div id="schedulePreview">
                        <!-- Schedule preview will be loaded here -->
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading preview...</span>
                            </div>
                            <p class="mt-2">Generating schedule preview...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pattern Explanation -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="bi bi-book"></i> How This Pattern Works</h5>
                </div>
                <div class="card-body">
                    <div id="patternExplanation">
                        <!-- Pattern explanation will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.schedule-grid {
    display: grid;
    grid-template-columns: auto repeat(7, 1fr);
    gap: 1px;
    background: #dee2e6;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    overflow: hidden;
}

.schedule-cell {
    background: white;
    padding: 8px;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-size: 0.875rem;
}

.schedule-header {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.schedule-week {
    background: #e9ecef;
    font-weight: 600;
    color: #495057;
    writing-mode: vertical-rl;
    text-orientation: mixed;
}

.shift-day {
    background: #fff3cd;
    color: #856404;
    border-left: 3px solid #ffc107;
}

.shift-night {
    background: #cce5ff;
    color: #004085;
    border-left: 3px solid #007bff;
}

.shift-evening {
    background: #ffe6cc;
    color: #8b4000;
    border-left: 3px solid #fd7e14;
}

.shift-off {
    background: #d1edff;
    color: #0c5460;
}

.crew-label {
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 2px;
}

.shift-time {
    font-size: 0.7rem;
    opacity: 0.8;
}

.pattern-info .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.pattern-info .info-item:last-child {
    border-bottom: none;
}

.crew-stat {
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .schedule-grid {
        grid-template-columns: auto repeat(3, 1fr);
    }
    
    .schedule-cell {
        min-height: 40px;
        padding: 4px;
        font-size: 0.75rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pattern = '{{ pattern }}';
    const patternConfig = {{ pattern_config | tojson }};
    
    // ===== COMPLETE PATTERN DATA FOR ALL 26+ PATTERNS =====
    const patternData = {
        'pitman': {
            cycle: '14 days',
            avgHours: '42 hours/week',
            maxConsecutive: '3 days',
            weekendsOff: 'Every other weekend',
            advantages: ['Balanced work-life', 'Never more than 3 days', 'Regular weekends', 'Well-tested'],
            considerations: ['Can work 7 days across weeks', 'Complex initially'],
            explanation: 'Pitman (2-2-3): Work 2, off 2, work 3, off 2, work 2, off 3. 14-day cycle with every other weekend off.'
        },
        'dupont': {
            cycle: '28 days',
            avgHours: '42 hours/week',
            maxConsecutive: '4 days',
            weekendsOff: 'One 7-day break',
            advantages: ['7 consecutive days off', 'Built-in recovery', 'Popular'],
            considerations: ['Must rotate', 'Complex pattern'],
            explanation: 'DuPont: 4N-3off-3D-1off-3N-3off-4D-7off. Famous for the 7-day break.'
        },
        'southern_swing': {
            cycle: '28 days',
            avgHours: '40 hours/week',
            maxConsecutive: '7 days',
            weekendsOff: '1 per month',
            advantages: ['Experience all shifts', 'Forward rotation', 'Traditional'],
            considerations: ['Only 1 weekend/month', 'Constant rotation'],
            explanation: 'Southern Swing: Rotate through days→evenings→nights over 4 weeks.'
        }
    };
    
    // ===== COMPLETE PATTERN GENERATION FOR ALL 26+ PATTERNS =====
    function generateCrewAssignment(pattern, week, day, rotation) {
        const dayOfCycle = (week - 1) * 7 + day;
        let assignment = {
            crews: 'Off',
            time: '',
            cssClass: 'shift-off'
        };
        
        // Get shift times from inputs
        const dayStart = document.getElementById('dayStart').value || '06:00';
        const nightStart = document.getElementById('nightStart').value || '18:00';
        const eveningStart = document.getElementById('eveningStart')?.value || '15:00';
        
        // Normalize pattern name to handle all variations
        let normalizedPattern = pattern.toLowerCase()
            .replace(/_/g, '')
            .replace(/-/g, '')
            .replace(/\s+/g, '');
        
        // Map all pattern variations to their base patterns
        const patternMap = {
            // Pitman variations
            'pitman': 'pitman',
            'pitmanschedule': 'pitman',
            '223': 'pitman',
            'pitmanfixed': 'pitman',
            'pitmanrapid': 'pitman',
            'pitman2week': 'pitman',
            'pitman4week': 'pitman',
            
            // DuPont variations
            'dupont': 'dupont',
            'dupontschedule': 'dupont',
            
            // Southern Swing
            'southernswing': 'southernswing',
            
            // Fixed Teams
            'fixedfixed': 'fixedteams',
            'fixedteams': 'fixedteams',
            'weekdayweekend': 'fixedteams',
            
            // 4-on-4-off variations
            'fouronfouroff': 'fouronfouroff',
            'fouronfouroffmodified': 'fouronfouroff',
            '4on4off': 'fouronfouroff',
            '44': 'fouronfouroff',
            
            // 5&2 variations
            'fiveandtwo': 'fiveandtwo',
            '52': 'fiveandtwo',
            '5and2': 'fiveandtwo',
            
            // 6&3 variations
            'sixandthree': 'sixandthree',
            '63': 'sixandthree',
            '6and3': 'sixandthree',
            
            // 7&3 variations
            'sevenandthree': 'sevenandthree',
            '73': 'sevenandthree',
            '7and3': 'sevenandthree',
            
            // Continental patterns
            'continental': 'continental',
            'continentalslowrotation': 'continental',
            
            // Panama variations
            'panama': 'panama',
            'panamaschedule': 'panama',
            '232': 'panama',
            
            // EOWEO
            'eoweo': 'eoweo',
            'everyotherweekend': 'eoweo',
            
            // Compressed Work Week
            'compressedworkweek': 'compressed',
            'compressed': 'compressed',
            '410': 'compressed',
            
            // Kelly Shift
            'kellyshift': 'kelly',
            'kelly': 'kelly',
            
            // California Shift
            'californiashift': 'california',
            'california': 'california',
            
            // Berkley variations
            'berkley': 'berkley',
            
            // Metropolitan Rota
            'metropolitanrota': 'metropolitan',
            'metropolitan': 'metropolitan',
            
            // 24-48 pattern
            '2448': 'twentyfourfortyeight',
            'twentyfourfortyeight': 'twentyfourfortyeight',
            
            // 48-96 pattern
            '4896': 'fortyeightninetysix',
            'fortyeightninetysix': 'fortyeightninetysix'
        };
        
        // Get the base pattern name
        const basePattern = patternMap[normalizedPattern] || normalizedPattern;
        
        // Generate assignment based on pattern
        switch(basePattern) {
            case 'pitman':
                // Pitman (2-2-3) Pattern
                const pitmanPattern = [1,1,0,0,1,1,1,0,0,1,1,0,0,0]; // 14-day cycle
                const pitmanDay = dayOfCycle % 14;
                
                // Determine which crews work
                const aWorks = pitmanPattern[pitmanDay];
                const bWorks = pitmanPattern[(pitmanDay + 7) % 14];
                const cWorks = aWorks; // C mirrors A
                const dWorks = bWorks; // D mirrors B
                
                if (rotation === 'fixed' || rotation.includes('fixed')) {
                    if (aWorks || bWorks) {
                        assignment.crews = [aWorks ? 'A' : '', bWorks ? 'B' : ''].filter(c => c).join(',');
                        assignment.time = `${dayStart}-${nightStart}`;
                        assignment.cssClass = 'shift-day';
                    }
                    if (cWorks || dWorks) {
                        const nightCrews = [cWorks ? 'C' : '', dWorks ? 'D' : ''].filter(c => c).join(',');
                        if (assignment.crews !== 'Off') {
                            assignment.crews += ' / ' + nightCrews;
                        } else {
                            assignment.crews = nightCrews;
                            assignment.time = `${nightStart}-${dayStart}`;
                            assignment.cssClass = 'shift-night';
                        }
                    }
                } else {
                    // Handle rotating variations
                    if (aWorks || bWorks) {
                        assignment.crews = aWorks ? 'A,C' : 'B,D';
                        assignment.time = `Rotating`;
                        assignment.cssClass = 'shift-day';
                    }
                }
                break;
                
            case 'dupont':
                // DuPont Pattern: 28-day cycle
                const dupontSchedule = 'NNNNOODDDDOONNNOOODDDDDOOOOOOO';
                const dupontOffsets = {'A': 0, 'B': 7, 'C': 14, 'D': 21};
                
                const dayCrews = [];
                const nightCrews = [];
                
                for (const [crew, offset] of Object.entries(dupontOffsets)) {
                    const schedDay = (dayOfCycle + offset) % 28;
                    const shift = dupontSchedule[schedDay];
                    if (shift === 'D') dayCrews.push(crew);
                    if (shift === 'N') nightCrews.push(crew);
                }
                
                if (dayCrews.length) {
                    assignment.crews = dayCrews.join(',');
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                if (nightCrews.length) {
                    if (assignment.crews !== 'Off') {
                        assignment.crews += ' / ' + nightCrews.join(',');
                    } else {
                        assignment.crews = nightCrews.join(',');
                        assignment.time = `${nightStart}-${dayStart}`;
                        assignment.cssClass = 'shift-night';
                    }
                }
                break;
                
            case 'southernswing':
                // Southern Swing: 8-hour shifts rotating
                const weekInMonth = Math.floor(dayOfCycle / 7) % 4;
                const dayOfWeek = day;
                
                if (weekInMonth === 0) {
                    // Week 1: Mon-Fri days
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        assignment.crews = 'All';
                        assignment.time = `${dayStart}-${eveningStart}`;
                        assignment.cssClass = 'shift-day';
                    }
                } else if (weekInMonth === 1) {
                    // Week 2: Wed-Sun evenings
                    if (dayOfWeek >= 3 || dayOfWeek === 0) {
                        assignment.crews = 'All';
                        assignment.time = `${eveningStart}-23:00`;
                        assignment.cssClass = 'shift-evening';
                    }
                } else if (weekInMonth === 2) {
                    // Week 3: Mon-Tue eve, Thu-Sun nights
                    if (dayOfWeek <= 2 && dayOfWeek >= 1) {
                        assignment.crews = 'All';
                        assignment.time = `${eveningStart}-23:00`;
                        assignment.cssClass = 'shift-evening';
                    } else if (dayOfWeek >= 4 || dayOfWeek === 0) {
                        assignment.crews = 'All';
                        assignment.time = `23:00-${dayStart}`;
                        assignment.cssClass = 'shift-night';
                    }
                } else {
                    // Week 4: Mon-Wed nights, Sat-Sun days
                    if (dayOfWeek >= 1 && dayOfWeek <= 3) {
                        assignment.crews = 'All';
                        assignment.time = `23:00-${dayStart}`;
                        assignment.cssClass = 'shift-night';
                    } else if (dayOfWeek >= 6 || dayOfWeek === 0) {
                        assignment.crews = 'All';
                        assignment.time = `${dayStart}-${eveningStart}`;
                        assignment.cssClass = 'shift-day';
                    }
                }
                break;
                
            case 'fouronfouroff':
                // 4-on-4-off Pattern
                const fourOnPattern = [1,1,1,1,0,0,0,0];
                const fourOnOffsets = {'A': 0, 'B': 2, 'C': 4, 'D': 6};
                const workingCrews = [];
                
                for (const [crew, offset] of Object.entries(fourOnOffsets)) {
                    if (fourOnPattern[(dayOfCycle + offset) % 8]) {
                        workingCrews.push(crew);
                    }
                }
                
                if (workingCrews.length) {
                    // Check if this is the modified version
                    if (pattern.includes('modified')) {
                        // Modified 4-on-4-off creates full weekends
                        const weekendAdjust = (day === 0 || day === 6) ? 1 : 0;
                        if (weekendAdjust && dayOfCycle % 14 < 7) {
                            assignment.crews = 'Off';
                        } else {
                            assignment.crews = workingCrews.join(',');
                            assignment.time = `${dayStart}-${nightStart}`;
                            assignment.cssClass = 'shift-day';
                        }
                    } else {
                        // Standard 4-on-4-off
                        assignment.crews = workingCrews.join(',');
                        assignment.time = `${dayStart}-${nightStart}`;
                        assignment.cssClass = 'shift-day';
                    }
                }
                break;
                
            case 'fixedteams':
                // Fixed Teams (Weekday vs Weekend)
                if (day >= 1 && day <= 4) {
                    // Monday-Thursday
                    assignment.crews = 'A,B';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                } else {
                    // Friday-Sunday
                    assignment.crews = 'C,D';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'fiveandtwo':
                // 5&2 Pattern: 5 on, 2 off, 5 on, 5 off, 2 on, 2 off
                const fiveTwo = [1,1,1,1,1,0,0,1,1,1,1,1,0,0,0,0,0,1,1,0,0];
                const fiveTwoDay = dayOfCycle % 21;
                if (fiveTwo[fiveTwoDay]) {
                    assignment.crews = 'A,B';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'sixandthree':
                // 6&3 Pattern: 6 on, 3 off, 6 on, 3 off
                const sixThree = [1,1,1,1,1,1,0,0,0];
                if (sixThree[dayOfCycle % 9]) {
                    assignment.crews = 'A,B';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'sevenandthree':
                // 7&3 Pattern: 7 on, 3 off
                const sevenThree = [1,1,1,1,1,1,1,0,0,0];
                if (sevenThree[dayOfCycle % 10]) {
                    assignment.crews = 'Working';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'continental':
                // Continental: 2D-2E-2N-2off pattern
                const contPattern = ['D','D','E','E','N','N','O','O'];
                const contDay = dayOfCycle % 8;
                const shift = contPattern[contDay];
                
                if (shift === 'D') {
                    assignment.crews = 'Day Crew';
                    assignment.time = `${dayStart}-${eveningStart}`;
                    assignment.cssClass = 'shift-day';
                } else if (shift === 'E') {
                    assignment.crews = 'Evening Crew';
                    assignment.time = `${eveningStart}-23:00`;
                    assignment.cssClass = 'shift-evening';
                } else if (shift === 'N') {
                    assignment.crews = 'Night Crew';
                    assignment.time = `23:00-${dayStart}`;
                    assignment.cssClass = 'shift-night';
                }
                break;
                
            case 'panama':
                // Panama (2-3-2): 2 on, 2 off, 3 on, 2 off, 2 on, 3 off
                const panamaPattern = [1,1,0,0,1,1,1,0,0,1,1,0,0,0];
                if (panamaPattern[dayOfCycle % 14]) {
                    assignment.crews = 'Working';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'eoweo':
                // EOWEO: Every Other Weekend Off
                const weekNum = Math.floor(dayOfCycle / 7);
                const isWeekend = (day === 0 || day === 6);
                
                if (weekNum % 2 === 0) {
                    // Even weeks: work weekdays, off weekends
                    if (!isWeekend) {
                        assignment.crews = 'A,B';
                        assignment.time = `${dayStart}-17:00`;
                        assignment.cssClass = 'shift-day';
                    }
                } else {
                    // Odd weeks: work all days
                    assignment.crews = 'A,B';
                    assignment.time = `${dayStart}-17:00`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'compressed':
                // Compressed Work Week: 4x10 hour days
                if (day >= 1 && day <= 4) {
                    assignment.crews = 'All';
                    assignment.time = '07:00-17:00';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'kelly':
                // Kelly Shift: 24 on, 24 off, 24 on, 24 off, 24 on, 96 off
                const kellyPattern = [1,0,1,0,1,0,0,0,0];
                if (kellyPattern[dayOfCycle % 9]) {
                    assignment.crews = 'On Duty';
                    assignment.time = '24 hours';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'california':
                // California Shift: 3x12 hour shifts with 4 days off
                const calPattern = [1,1,1,0,0,0,0];
                if (calPattern[dayOfCycle % 7]) {
                    assignment.crews = 'Working';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'berkley':
                // Berkley: Unique fire department schedule
                const berkPattern = [1,0,1,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,1,0,1,0,0,0,0,0,0,0];
                if (berkPattern[dayOfCycle % 28]) {
                    assignment.crews = 'On Duty';
                    assignment.time = '24 hours';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'metropolitan':
                // Metropolitan Rota: 2 earlies, 2 lates, 2 nights, 4 off
                const metroPattern = ['E','E','L','L','N','N','O','O','O','O'];
                const metroDay = dayOfCycle % 10;
                const metroShift = metroPattern[metroDay];
                
                if (metroShift === 'E') {
                    assignment.crews = 'Early';
                    assignment.time = '06:00-14:00';
                    assignment.cssClass = 'shift-day';
                } else if (metroShift === 'L') {
                    assignment.crews = 'Late';
                    assignment.time = '14:00-22:00';
                    assignment.cssClass = 'shift-evening';
                } else if (metroShift === 'N') {
                    assignment.crews = 'Night';
                    assignment.time = '22:00-06:00';
                    assignment.cssClass = 'shift-night';
                }
                break;
                
            case 'twentyfourfortyeight':
                // 24-48: 24 hours on, 48 hours off
                const tfPattern = [1,0,0];
                if (tfPattern[dayOfCycle % 3]) {
                    assignment.crews = 'On Duty';
                    assignment.time = '24 hours';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'fortyeightninetysix':
                // 48-96: 48 hours on, 96 hours off
                const fnsPattern = [1,1,0,0,0,0];
                if (fnsPattern[dayOfCycle % 6]) {
                    assignment.crews = 'On Duty';
                    assignment.time = '48 hours';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            default:
                // For any patterns not yet implemented
                assignment.crews = `${pattern} Pattern`;
                assignment.time = 'Configuration needed';
                assignment.cssClass = 'shift-day';
                break;
        }
        
        return assignment;
    }
    
    // Populate pattern information
    const patternInfo = patternData[pattern] || patternData[pattern.split('_')[0]] || {
        cycle: 'Custom',
        avgHours: '40-42 hours/week',
        maxConsecutive: 'Varies',
        weekendsOff: 'Varies',
        advantages: ['Pattern specific'],
        considerations: ['Pattern specific'],
        explanation: `${patternConfig.name || pattern} pattern implementation`
    };
    
    const infoHtml = `
        <div class="info-item">
            <span>Cycle Length:</span>
            <strong>${patternInfo.cycle}</strong>
        </div>
        <div class="info-item">
            <span>Average Hours:</span>
            <strong>${patternInfo.avgHours}</strong>
        </div>
        <div class="info-item">
            <span>Max Consecutive:</span>
            <strong>${patternInfo.maxConsecutive}</strong>
        </div>
        <div class="info-item">
            <span>Weekends Off:</span>
            <strong>${patternInfo.weekendsOff}</strong>
        </div>
        <div class="mt-3">
            <h6 class="text-success">Advantages:</h6>
            <ul class="list-unstyled">
                ${(patternInfo.advantages || []).map(item => `<li class="text-success"><i class="bi bi-check-circle"></i> ${item}</li>`).join('')}
            </ul>
        </div>
        <div class="mt-3">
            <h6 class="text-warning">Considerations:</h6>
            <ul class="list-unstyled">
                ${(patternInfo.considerations || []).map(item => `<li class="text-warning"><i class="bi bi-exclamation-triangle"></i> ${item}</li>`).join('')}
            </ul>
        </div>
    `;
    
    document.getElementById('patternInfo').innerHTML = infoHtml;
    document.getElementById('patternExplanation').innerHTML = `<p>${patternInfo.explanation}</p>`;
    
    // Generate schedule preview
    function generateSchedulePreview() {
        const startDate = new Date(document.getElementById('startDate').value);
        const rotation = document.getElementById('shiftRotation').value;
        
        // Generate 4 weeks of preview data
        let previewHtml = '<div class="schedule-grid">';
        
        // Header row
        previewHtml += '<div class="schedule-cell schedule-header">Week</div>';
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
            previewHtml += `<div class="schedule-cell schedule-header">${day}</div>`;
        });
        
        // Generate 4 weeks
        for (let week = 1; week <= 4; week++) {
            previewHtml += `<div class="schedule-cell schedule-week">Week ${week}</div>`;
            
            for (let day = 0; day < 7; day++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + (week - 1) * 7 + day);
                
                // Generate crew assignments based on pattern
                const assignment = generateCrewAssignment(pattern, week, day, rotation);
                
                previewHtml += `<div class="schedule-cell ${assignment.cssClass}">
                    <div class="crew-label">${assignment.crews}</div>
                    <div class="shift-time">${assignment.time}</div>
                </div>`;
            }
        }
        
        previewHtml += '</div>';
        
        // Add legend
        previewHtml += `
            <div class="mt-3">
                <h6>Legend:</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-1">
                            <div class="shift-day" style="width: 20px; height: 20px; border-radius: 3px; margin-right: 8px;"></div>
                            <span>Day Shift</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-1">
                            <div class="shift-night" style="width: 20px; height: 20px; border-radius: 3px; margin-right: 8px;"></div>
                            <span>Night Shift</span>
                        </div>
                    </div>
                    ${patternConfig.shift_hours === 8 ? `
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-1">
                            <div class="shift-evening" style="width: 20px; height: 20px; border-radius: 3px; margin-right: 8px;"></div>
                            <span>Evening Shift</span>
                        </div>
                    </div>
                    ` : ''}
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-1">
                            <div class="shift-off" style="width: 20px; height: 20px; border-radius: 3px; margin-right: 8px;"></div>
                            <span>Off Day</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-3">
                <strong>Pattern: ${patternConfig.name || pattern}</strong><br>
                This preview shows the actual schedule pattern. Specific employees will be assigned based on their current crew assignments.
            </div>
        `;
        
        document.getElementById('schedulePreview').innerHTML = previewHtml;
    }
    
    // Event listeners
    document.getElementById('refreshPreview').addEventListener('click', generateSchedulePreview);
    document.getElementById('startDate').addEventListener('change', generateSchedulePreview);
    document.getElementById('shiftRotation').addEventListener('change', generateSchedulePreview);
    
    // Create schedule button
    document.getElementById('createScheduleBtn').addEventListener('click', function() {
        const config = {
            pattern: pattern,
            rotation: document.getElementById('shiftRotation').value,
            startDate: document.getElementById('startDate').value,
            dayStart: document.getElementById('dayStart').value,
            nightStart: document.getElementById('nightStart')?.value,
            eveningStart: document.getElementById('eveningStart')?.value
        };
        
        console.log('Schedule Configuration:', config);
        alert(`Creating ${patternConfig.name || pattern} schedule...\n\nConfiguration logged to console.`);
    });
    
    // Generate initial preview after page loads
    setTimeout(generateSchedulePreview, 500);
});
</script>
{% endblock %}
