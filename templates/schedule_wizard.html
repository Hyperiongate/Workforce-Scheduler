{% extends "base.html" %}

{% block title %}Create {{ pattern_config.name }} Schedule - Workforce Scheduler{% endblock %}

{% block extra_head %}
<style>
    .wizard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .wizard-header {
        text-align: center;
        margin-bottom: 3rem;
    }
    
    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3rem;
        position: relative;
    }
    
    .wizard-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #dee2e6;
        z-index: -1;
    }
    
    .step {
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        border: 2px solid #dee2e6;
        color: #6c757d;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .step.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .step.completed {
        background: #28a745;
        color: white;
        border-color: #28a745;
    }
    
    .wizard-content {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    .pattern-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .crew-card {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
    }
    
    .crew-card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .crew-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: bold;
        margin-right: 0.5rem;
    }
    
    .crew-A { background: #d4edda; color: #155724; }
    .crew-B { background: #d1ecf1; color: #0c5460; }
    .crew-C { background: #fff3cd; color: #856404; }
    .crew-D { background: #f8d7da; color: #721c24; }
    
    .preview-calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-top: 1rem;
    }
    
    .calendar-day {
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        min-height: 80px;
        font-size: 0.875rem;
    }
    
    .calendar-header {
        background: #f8f9fa;
        font-weight: bold;
        text-align: center;
        padding: 0.5rem;
    }
    
    .shift-block {
        padding: 2px 4px;
        margin: 1px;
        border-radius: 3px;
        font-size: 0.75rem;
    }
    
    .shift-day { background: #ffeaa7; }
    .shift-night { background: #74b9ff; }
    .shift-evening { background: #fd79a8; }
    
    .validation-result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
    }
    
    .validation-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .validation-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-header">
        <h1>Create {{ pattern_config.name }} Schedule</h1>
        <p class="text-muted">Follow the steps below to create your schedule</p>
    </div>

    <!-- Progress Steps -->
    <div class="wizard-steps">
        <div class="step active" id="step1">1. Configuration</div>
        <div class="step" id="step2">2. Crew Verification</div>
        <div class="step" id="step3">3. Preview</div>
        <div class="step" id="step4">4. Create</div>
    </div>

    <div class="wizard-content">
        <!-- Step 1: Configuration -->
        <div id="step1-content" class="step-content">
            <h3>Step 1: Configure Schedule Parameters</h3>
            
            <div class="pattern-info">
                <h5>{{ pattern_config.name }} Pattern Details:</h5>
                <ul>
                    <li>Shift Length: {{ pattern_config.shift_hours }}-hour shifts</li>
                    <li>Rotation Options: 
                        {% if pattern_config.allows_fixed and pattern_config.allows_rotating %}
                            Fixed or Rotating
                        {% elif pattern_config.allows_fixed %}
                            Fixed shifts only
                        {% else %}
                            Rotating shifts only
                        {% endif %}
                    </li>
                </ul>
            </div>

            <form id="scheduleForm">
                <input type="hidden" name="pattern" value="{{ pattern }}">
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Schedule Name</label>
                            <input type="text" class="form-control" name="schedule_name" 
                                   placeholder="e.g., Q1 2025 Production Schedule" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" 
                                   value="{{ date.today() }}" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" required>
                            <small class="text-muted">Typically 3-6 months for pattern schedules</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        {% if pattern_config.allows_fixed and pattern_config.allows_rotating %}
                        <div class="mb-3">
                            <label class="form-label">Shift Type</label>
                            <select class="form-select" name="shift_type" onchange="updateRotationOptions()">
                                <option value="fixed">Fixed (crews always work same shift)</option>
                                <option value="rotating">Rotating (crews alternate shifts)</option>
                            </select>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div id="rotationOptions" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Rotation Frequency</label>
                                <select class="form-select" name="variation">
                                    {% for option in pattern_config.rotation_options %}
                                    <option value="{{ option }}">{{ option|title|replace('_', ' ') }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Day Shift Start</label>
                            <input type="time" class="form-control" name="day_shift_start" value="06:00">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Night Shift Start</label>
                            <input type="time" class="form-control" name="night_shift_start" value="18:00">
                        </div>
                    </div>
                    {% if pattern_config.shift_hours == 8 %}
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Evening Shift Start</label>
                            <input type="time" class="form-control" name="evening_shift_start" value="14:00">
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="fair_rotation" id="fairRotation" checked>
                    <label class="form-check-label" for="fairRotation">
                        Ensure fair distribution of weekends and holidays
                    </label>
                </div>
            </form>

            <div class="d-flex justify-content-end">
                <button class="btn btn-primary" onclick="nextStep()">Next →</button>
            </div>
        </div>

        <!-- Step 2: Crew Verification -->
        <div id="step2-content" class="step-content" style="display: none;">
            <h3>Step 2: Verify Crew Assignments</h3>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Ensure all 4 crews have sufficient employees before proceeding.
            </div>

            <div class="row">
                {% for crew in ['A', 'B', 'C', 'D'] %}
                <div class="col-md-6">
                    <div class="crew-card">
                        <h5><span class="crew-badge crew-{{ crew }}">Crew {{ crew }}</span></h5>
                        <p class="mb-2">
                            <strong>{{ crew_stats[crew].count }}</strong> employees
                        </p>
                        <div class="small">
                            {% if crew_stats[crew].positions %}
                                {% for pos, count in crew_stats[crew].positions.items() %}
                                    {{ pos }}: {{ count }}<br>
                                {% endfor %}
                            {% else %}
                                <span class="text-danger">No positions assigned</span>
                            {% endif %}
                        </div>
                        {% if crew_stats[crew].count < 5 %}
                        <div class="alert alert-warning mt-2 mb-0">
                            <small>Warning: Crew has fewer than 5 employees</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if unassigned_employees %}
            <div class="alert alert-warning mt-3">
                <h6>Unassigned Employees ({{ unassigned_employees|length }})</h6>
                <small>
                    {% for emp in unassigned_employees[:5] %}
                        {{ emp.name }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if unassigned_employees|length > 5 %}
                        ... and {{ unassigned_employees|length - 5 }} more
                    {% endif %}
                </small>
            </div>
            {% endif %}

            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-secondary" onclick="previousStep()">← Previous</button>
                <button class="btn btn-primary" onclick="generatePreview()">Generate Preview →</button>
            </div>
        </div>

        <!-- Step 3: Preview -->
        <div id="step3-content" class="step-content" style="display: none;">
            <h3>Step 3: Preview Schedule</h3>
            
            <div class="mb-3">
                <button class="btn btn-sm btn-outline-primary" onclick="changePreviewWeek(-1)">
                    <i class="bi bi-chevron-left"></i> Previous Week
                </button>
                <span class="mx-3" id="previewWeekLabel">Week 1</span>
                <button class="btn btn-sm btn-outline-primary" onclick="changePreviewWeek(1)">
                    Next Week <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <div id="schedulePreview">
                <!-- Calendar preview will be inserted here -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading preview...</span>
                    </div>
                </div>
            </div>

            <div id="previewStats" class="mt-4">
                <!-- Statistics will be shown here -->
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-secondary" onclick="previousStep()">← Previous</button>
                <button class="btn btn-primary" onclick="validateSchedule()">Validate & Continue →</button>
            </div>
        </div>

        <!-- Step 4: Create -->
        <div id="step4-content" class="step-content" style="display: none;">
            <h3>Step 4: Create Schedule</h3>
            
            <div id="validationResults">
                <!-- Validation results will be shown here -->
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Schedule Summary</h5>
                    <dl class="row">
                        <dt class="col-sm-3">Pattern:</dt>
                        <dd class="col-sm-9">{{ pattern_config.name }}</dd>
                        
                        <dt class="col-sm-3">Date Range:</dt>
                        <dd class="col-sm-9" id="summaryDateRange">-</dd>
                        
                        <dt class="col-sm-3">Total Shifts:</dt>
                        <dd class="col-sm-9" id="summaryTotalShifts">-</dd>
                        
                        <dt class="col-sm-3">Crews:</dt>
                        <dd class="col-sm-9">A, B, C, D</dd>
                    </dl>
                </div>
            </div>

            <div class="alert alert-warning mt-4">
                <i class="bi bi-exclamation-triangle"></i> 
                <strong>Important:</strong> Creating this schedule will replace any existing schedules in the selected date range.
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-secondary" onclick="previousStep()">← Previous</button>
                <button class="btn btn-success btn-lg" onclick="createSchedule()" id="createBtn">
                    <i class="bi bi-check-circle"></i> Create Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loadingMessage">Generating schedule...</h5>
                <p class="text-muted mb-0">This may take a moment for large date ranges.</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let previewData = null;
let currentPreviewWeek = 0;

function updateRotationOptions() {
    const shiftType = document.querySelector('[name="shift_type"]').value;
    const rotationDiv = document.getElementById('rotationOptions');
    
    if (shiftType === 'rotating') {
        rotationDiv.style.display = 'block';
    } else {
        rotationDiv.style.display = 'none';
    }
}

function nextStep() {
    if (validateCurrentStep()) {
        document.getElementById(`step${currentStep}-content`).style.display = 'none';
        document.getElementById(`step${currentStep}`).classList.remove('active');
        document.getElementById(`step${currentStep}`).classList.add('completed');
        
        currentStep++;
        
        document.getElementById(`step${currentStep}-content`).style.display = 'block';
        document.getElementById(`step${currentStep}`).classList.add('active');
    }
}

function previousStep() {
    document.getElementById(`step${currentStep}-content`).style.display = 'none';
    document.getElementById(`step${currentStep}`).classList.remove('active');
    
    currentStep--;
    
    document.getElementById(`step${currentStep}-content`).style.display = 'block';
    document.getElementById(`step${currentStep}`).classList.add('active');
    document.getElementById(`step${currentStep}`).classList.remove('completed');
}

function validateCurrentStep() {
    if (currentStep === 1) {
        const form = document.getElementById('scheduleForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return false;
        }
        
        // Check date range
        const startDate = new Date(form.start_date.value);
        const endDate = new Date(form.end_date.value);
        
        if (endDate <= startDate) {
            alert('End date must be after start date');
            return false;
        }
        
        const daysDiff = (endDate - startDate) / (1000 * 60 * 60 * 24);
        if (daysDiff > 365) {
            if (!confirm('Schedule spans more than a year. Continue?')) {
                return false;
            }
        }
    }
    
    return true;
}

function generatePreview() {
    const form = document.getElementById('scheduleForm');
    const formData = new FormData(form);
    
    // Show loading
    document.getElementById('schedulePreview').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading preview...</span>
            </div>
        </div>
    `;
    
    // Convert form data to JSON
    const data = {
        pattern: formData.get('pattern'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        variation: formData.get('variation') || 'fixed',
        day_shift_start: formData.get('day_shift_start'),
        night_shift_start: formData.get('night_shift_start'),
        shift_type: formData.get('shift_type') || 'fixed'
    };
    
    fetch('/schedule/preview-pattern', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            previewData = data;
            displayPreview();
            nextStep();
        } else {
            alert('Error generating preview: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function displayPreview() {
    if (!previewData) return;
    
    const startDate = new Date(document.getElementById('scheduleForm').start_date.value);
    const weekStart = new Date(startDate);
    weekStart.setDate(weekStart.getDate() + (currentPreviewWeek * 7));
    
    let html = '<div class="preview-calendar">';
    
    // Headers
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    days.forEach(day => {
        html += `<div class="calendar-header">${day}</div>`;
    });
    
    // Calendar days
    for (let i = 0; i < 7; i++) {
        const currentDate = new Date(weekStart);
        currentDate.setDate(currentDate.getDate() + i);
        const dateStr = currentDate.toISOString().split('T')[0];
        
        html += '<div class="calendar-day">';
        html += `<div class="fw-bold">${currentDate.getDate()}</div>`;
        
        // Get shifts for this date
        const dayShifts = previewData.calendar_data.filter(s => s.start === dateStr);
        
        // Group by shift type
        const shiftGroups = {
            day: dayShifts.filter(s => s.shift === 'day'),
            evening: dayShifts.filter(s => s.shift === 'evening'),
            night: dayShifts.filter(s => s.shift === 'night')
        };
        
        // Display shifts
        Object.entries(shiftGroups).forEach(([type, shifts]) => {
            if (shifts.length > 0) {
                const crews = [...new Set(shifts.map(s => s.crew))].sort();
                html += `<div class="shift-block shift-${type}">${type[0].toUpperCase()}: ${crews.join(',')}</div>`;
            }
        });
        
        html += '</div>';
    }
    
    html += '</div>';
    
    document.getElementById('schedulePreview').innerHTML = html;
    document.getElementById('previewWeekLabel').textContent = `Week ${currentPreviewWeek + 1}`;
    
    // Update statistics
    updatePreviewStats();
}

function changePreviewWeek(direction) {
    const maxWeeks = 4; // Show 4 weeks of preview
    currentPreviewWeek = Math.max(0, Math.min(maxWeeks - 1, currentPreviewWeek + direction));
    displayPreview();
}

function updatePreviewStats() {
    if (!previewData) return;
    
    const stats = previewData.summary;
    let totalDay = 0, totalNight = 0, totalEvening = 0;
    
    Object.values(stats).forEach(day => {
        totalDay += day.day || 0;
        totalNight += day.night || 0;
        totalEvening += day.evening || 0;
    });
    
    let html = '<div class="row">';
    html += '<div class="col-md-4"><div class="card"><div class="card-body text-center">';
    html += `<h6>Day Shifts</h6><h3>${totalDay}</h3>`;
    html += '</div></div></div>';
    
    html += '<div class="col-md-4"><div class="card"><div class="card-body text-center">';
    html += `<h6>Night Shifts</h6><h3>${totalNight}</h3>`;
    html += '</div></div></div>';
    
    if (totalEvening > 0) {
        html += '<div class="col-md-4"><div class="card"><div class="card-body text-center">';
        html += `<h6>Evening Shifts</h6><h3>${totalEvening}</h3>`;
        html += '</div></div></div>';
    }
    
    html += '</div>';
    
    document.getElementById('previewStats').innerHTML = html;
}

function validateSchedule() {
    document.getElementById('loadingMessage').textContent = 'Validating schedule...';
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
    
    const form = document.getElementById('scheduleForm');
    const formData = new FormData(form);
    
    const data = {
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date')
    };
    
    fetch('/api/schedule/validate-coverage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        modal.hide();
        
        let html = '';
        if (data.valid) {
            html = '<div class="validation-result validation-success">';
            html += '<h5><i class="bi bi-check-circle"></i> Validation Passed</h5>';
            html += '<p>Schedule meets all coverage requirements.</p>';
            html += '</div>';
        } else {
            html = '<div class="validation-result validation-error">';
            html += '<h5><i class="bi bi-x-circle"></i> Coverage Issues Found</h5>';
            html += '<p>The following coverage gaps were detected:</p>';
            html += '<ul>';
            data.issues.slice(0, 5).forEach(issue => {
                html += `<li>${issue.date} - ${issue.shift} shift: ${issue.position} (${issue.actual}/${issue.required})</li>`;
            });
            if (data.issues.length > 5) {
                html += `<li>... and ${data.issues.length - 5} more issues</li>`;
            }
            html += '</ul>';
            html += '</div>';
        }
        
        document.getElementById('validationResults').innerHTML = html;
        
        // Update summary
        document.getElementById('summaryDateRange').textContent = 
            `${formData.get('start_date')} to ${formData.get('end_date')}`;
        document.getElementById('summaryTotalShifts').textContent = 
            previewData ? previewData.total_shifts : 'Unknown';
        
        nextStep();
    })
    .catch(error => {
        modal.hide();
        alert('Validation error: ' + error);
    });
}

function createSchedule() {
    if (!confirm('Are you sure you want to create this schedule? This will replace any existing schedules in the date range.')) {
        return;
    }
    
    const btn = document.getElementById('createBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
    
    const form = document.getElementById('scheduleForm');
    const formData = new FormData(form);
    
    const data = {
        pattern: formData.get('pattern'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        variation: formData.get('variation') || 'fixed',
        day_shift_start: formData.get('day_shift_start'),
        night_shift_start: formData.get('night_shift_start'),
        shift_type: formData.get('shift_type') || 'fixed',
        fair_rotation: formData.get('fair_rotation') === 'on',
        force_overwrite: true
    };
    
    fetch('/schedule/create-pattern', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = data.redirect_url;
        } else {
            alert('Error creating schedule: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Create Schedule';
        }
    })
    .catch(error => {
        alert('Error: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Create Schedule';
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    {% if pattern_config.allows_fixed and pattern_config.allows_rotating %}
        updateRotationOptions();
    {% endif %}
});
</script>
{% endblock %}
