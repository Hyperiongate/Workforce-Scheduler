{% extends "base.html" %}
{% block title %}{{ pattern_config.name }} Schedule Pattern{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2">{{ pattern_config.name }} Schedule Pattern</h1>
                    <p class="text-muted">Learn about this pattern and preview how it works</p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('schedule.schedule_select') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Patterns
                    </a>
                    <button class="btn btn-primary" id="createScheduleBtn">
                        <i class="bi bi-calendar-plus"></i> Create This Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Pattern Information -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-info-circle"></i> Pattern Details</h5>
                </div>
                <div class="card-body">
                    <div class="pattern-info" id="patternInfo">
                        <!-- Pattern details will be populated by JavaScript -->
                    </div>
                    
                    <hr>
                    
                    <div class="crew-requirements">
                        <h6>Crew Requirements</h6>
                        <div class="row">
                            {% for crew in ['A', 'B', 'C', 'D'] %}
                            <div class="col-6 mb-2">
                                <div class="crew-stat">
                                    <strong>Crew {{ crew }}:</strong> {{ crew_stats[crew]['count'] }} employees
                                    {% if crew_stats[crew]['count'] == 0 %}
                                        <span class="badge bg-warning ms-1">Empty</span>
                                    {% elif crew_stats[crew]['count'] < 3 %}
                                        <span class="badge bg-info ms-1">Low</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if unassigned_employees %}
                        <div class="alert alert-info mt-2">
                            <small><i class="bi bi-exclamation-triangle"></i> {{ unassigned_employees|length }} unassigned employees need crew placement</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Pattern Configuration -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-gear"></i> Pattern Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="patternConfig">
                        {% if pattern == 'pitman' %}
                        <!-- Special Pitman Configuration -->
                        <div class="mb-3">
                            <label for="pitmanVariation" class="form-label">Select Pitman Rotation Type</label>
                            <select class="form-select" id="pitmanVariation" name="pitman_variation">
                                <option value="">-- Choose Rotation --</option>
                                <option value="fixed">Fixed Shifts (No Rotation)</option>
                                <option value="fast">Fast Rotation (Every Work Set)</option>
                                <option value="medium">Medium Rotation (Every 2 Weeks)</option>
                                <option value="slow">Slow Rotation (Every 4 Weeks)</option>
                            </select>
                            <div class="form-text">
                                <ul class="mb-0 mt-2">
                                    <li><strong>Fixed:</strong> A&B always work days, C&D always work nights (2-week cycle)</li>
                                    <li><strong>Fast:</strong> Rotate after each work stretch (4-week cycle)</li>
                                    <li><strong>Medium:</strong> Rotate every 2 weeks (4-week cycle)</li>
                                    <li><strong>Slow:</strong> Rotate every 4 weeks (8-week cycle)</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" id="generatePreviewBtn" style="display: none;">
                                <i class="bi bi-calendar-check"></i> Generate Schedule Preview
                            </button>
                        </div>
                        {% else %}
                        <div class="mb-3">
                            <label for="shiftRotation" class="form-label">Rotation Type</label>
                            <select class="form-select" id="shiftRotation" name="rotation_type">
                                {% if pattern_config.allows_fixed %}
                                <option value="fixed">Fixed Crews (No Rotation)</option>
                                {% endif %}
                                {% if pattern_config.allows_rotating %}
                                {% for option in pattern_config.rotation_options %}
                                <option value="{{ option.lower().replace(' ', '_') }}">{{ option }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" id="generatePreviewBtn">
                                <i class="bi bi-calendar-check"></i> Generate Schedule Preview
                            </button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- Pattern Preview -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-calendar-week"></i> Schedule Pattern Preview</h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshPreview">
                        <i class="bi bi-arrow-clockwise"></i> Update Preview
                    </button>
                </div>
                <div class="card-body">
                    <div id="schedulePreview">
                        <!-- Schedule preview will be loaded here -->
                        <div class="text-center p-4">
                            <i class="bi bi-calendar-week fs-1 text-muted"></i>
                            <p class="mt-2">Select configuration options to generate preview</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pattern Explanation -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="bi bi-book"></i> How This Pattern Works</h5>
                </div>
                <div class="card-body">
                    <div id="patternExplanation">
                        <!-- Pattern explanation will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Timeline View Styles - Updated 12/27/2024 */
.schedule-preview-container {
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.preview-header {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    color: white;
    padding: 25px;
    position: relative;
    overflow: hidden;
}

.preview-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 50%;
    height: 200%;
    background: rgba(255, 255, 255, 0.05);
    transform: rotate(-35deg);
}

.preview-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 8px;
    position: relative;
}

.preview-subtitle {
    opacity: 0.9;
    font-size: 0.9rem;
    position: relative;
}

/* Pattern Statistics Bar */
.pattern-stats {
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    padding: 20px;
    display: flex;
    justify-content: space-around;
    text-align: center;
    border-bottom: 1px solid #e2e8f0;
}

.stat-item {
    flex: 1;
}

.stat-value {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2d3748;
}

.stat-label {
    font-size: 0.8rem;
    color: #718096;
    margin-top: 5px;
}

/* Timeline Container */
.timeline-container {
    padding: 25px;
}

.week-timeline {
    margin-bottom: 35px;
}

.week-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e2e8f0;
}

.week-number {
    background: #4299e1;
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    font-weight: 600;
    margin-right: 15px;
    font-size: 0.9rem;
}

.week-info {
    color: #718096;
    font-size: 0.85rem;
}

/* Days Grid */
.days-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
}

.day-column {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.day-label {
    background: #2d3748;
    color: white;
    text-align: center;
    padding: 10px 5px;
    border-radius: 10px;
    font-weight: 500;
    font-size: 0.85rem;
}

.day-label.weekend {
    background: #805ad5;
}

/* Shift Blocks */
.shift-block {
    border-radius: 10px;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 4px;
}

.shift-block:hover {
    transform: scale(1.05);
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.shift-day {
    background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    color: #744210;
}

.shift-night {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.shift-off {
    background: #e2e8f0;
    color: #718096;
    opacity: 0.6;
}

.shift-label {
    font-size: 0.7rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.crew-letter {
    font-size: 1.1rem;
    font-weight: 700;
}

/* Legend */
.legend-strip {
    display: flex;
    justify-content: center;
    gap: 25px;
    padding: 20px;
    background: #f7fafc;
    border-top: 1px solid #e2e8f0;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85rem;
}

.legend-box {
    width: 35px;
    height: 22px;
    border-radius: 6px;
}

.pattern-info .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.pattern-info .info-item:last-child {
    border-bottom: none;
}

.crew-stat {
    font-size: 0.9rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .timeline-container {
        padding: 15px;
    }
    
    .days-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
    }
    
    .day-label {
        font-size: 0.75rem;
        padding: 8px 3px;
    }
    
    .shift-block {
        min-height: 45px;
        padding: 8px 5px;
    }
    
    .shift-label {
        font-size: 0.6rem;
    }
    
    .crew-letter {
        font-size: 0.9rem;
    }
    
    .pattern-stats {
        flex-wrap: wrap;
    }
    
    .stat-item {
        flex: 1 1 45%;
        margin-bottom: 10px;
    }
}

@media (max-width: 480px) {
    .days-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.pattern-info .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.pattern-info .info-item:last-child {
    border-bottom: none;
}

.crew-stat {
    font-size: 0.9rem;
}
</style>

<script>
// COMPLETE IMPLEMENTATION WITH ALL 26+ PATTERNS
// Updated: December 27, 2024
// Fixed: Button visibility, event listeners, and all pattern implementations

document.addEventListener('DOMContentLoaded', function() {
    console.log('===== Schedule Wizard Initialization =====');
    
    const pattern = '{{ pattern }}';
    const patternConfig = {{ pattern_config | tojson }};
    
    console.log('Pattern:', pattern);
    console.log('Pattern Config:', patternConfig);
    
    // ===== COMPLETE PATTERN DATA FOR ALL 26+ PATTERNS =====
    const patternData = {
        'pitman': {
            cycle: '14 days',
            avgHours: '42 hours/week',
            maxConsecutive: '3 days',
            weekendsOff: 'Every other weekend',
            advantages: ['Balanced work-life', 'Never more than 3 days', 'Regular weekends', 'Well-tested'],
            considerations: ['Can work 7 days across weeks', 'Complex initially'],
            explanation: 'Pitman (2-2-3): Work 2, off 2, work 3, off 2, work 2, off 3. 14-day cycle with every other weekend off.'
        },
        'dupont': {
            cycle: '28 days',
            avgHours: '42 hours/week',
            maxConsecutive: '4 days',
            weekendsOff: 'One 7-day break',
            advantages: ['7 consecutive days off', 'Built-in recovery', 'Popular'],
            considerations: ['Must rotate', 'Complex pattern'],
            explanation: 'DuPont: 4N-3off-3D-1off-3N-3off-4D-7off. Famous for the 7-day break.'
        },
        'southern_swing': {
            cycle: '28 days',
            avgHours: '40 hours/week',
            maxConsecutive: '7 days',
            weekendsOff: '1 per month',
            advantages: ['Experience all shifts', 'Forward rotation', 'Traditional'],
            considerations: ['Only 1 weekend/month', 'Constant rotation'],
            explanation: 'Southern Swing: Rotate through days→evenings→nights over 4 weeks.'
        },
        'four_on_four_off': {
            cycle: '8 days',
            avgHours: '42 hours/week',
            maxConsecutive: '4 days',
            weekendsOff: 'Varies',
            advantages: ['Simple pattern', 'Equal work/rest', 'Predictable'],
            considerations: ['Weekend coverage varies', 'Requires 4 crews'],
            explanation: '4-on-4-off: Work 4 days, then off 4 days. Simple and balanced.'
        },
        'fixed_teams': {
            cycle: '7 days',
            avgHours: '40 hours/week',
            maxConsecutive: '5 days',
            weekendsOff: 'Every weekend (day shift)',
            advantages: ['Consistent schedule', 'No rotation stress', 'Family-friendly'],
            considerations: ['Night shift always nights', 'Less variety'],
            explanation: 'Fixed Teams: Crews stay on same shift permanently. A&B days, C&D nights.'
        },
        'panama': {
            cycle: '14 days',
            avgHours: '42 hours/week',
            maxConsecutive: '3 days',
            weekendsOff: 'Every other weekend',
            advantages: ['Never work more than 3 consecutive', 'Every other weekend off'],
            considerations: ['Complex rotation', 'Requires adaptation'],
            explanation: 'Panama (2-3-2): 2 on, 2 off, 3 on, 2 off, 2 on, 3 off. Similar to Pitman.'
        },
        'continental': {
            cycle: '8 days',
            avgHours: '42 hours/week',
            maxConsecutive: '2 days',
            weekendsOff: 'Varies',
            advantages: ['Short work stretches', 'All three shifts', 'European standard'],
            considerations: ['Constant rotation', 'Body clock adjustment'],
            explanation: 'Continental: 2D-2E-2N-2off. Rotate through all shifts in 8 days.'
        },
        'eoweo': {
            cycle: '14 days',
            avgHours: '40 hours/week',
            maxConsecutive: '7 days',
            weekendsOff: 'Every other weekend',
            advantages: ['Simple pattern', 'Regular weekends', 'Popular'],
            considerations: ['7 consecutive work days', 'Weekend variability'],
            explanation: 'EOWEO: Every Other Weekend Off. Work weekdays, alternate weekends.'
        }
    };
    
    // ===== COMPLETE CREW ASSIGNMENT GENERATION FOR ALL PATTERNS =====
    function generateCrewAssignment(pattern, week, day, rotation) {
        const dayOfCycle = (week - 1) * 7 + day;
        let assignment = {
            crews: 'Off',
            time: '',
            cssClass: 'shift-off'
        };
        
        // Default shift times
        const dayStart = '06:00';
        const nightStart = '18:00';
        const eveningStart = '15:00';
        
        // Normalize pattern name
        let normalizedPattern = pattern.toLowerCase()
            .replace(/_/g, '')
            .replace(/-/g, '')
            .replace(/\s+/g, '');
        
        // Complete pattern mapping for all 26+ patterns
        const patternMap = {
            // Pitman variations
            'pitman': 'pitman',
            'pitmanschedule': 'pitman',
            '223': 'pitman',
            'pitmanfixed': 'pitman',
            'pitmanrapid': 'pitman',
            
            // DuPont variations
            'dupont': 'dupont',
            'dupontschedule': 'dupont',
            
            // Southern Swing
            'southernswing': 'southernswing',
            
            // Fixed Teams
            'fixedfixed': 'fixedteams',
            'fixedteams': 'fixedteams',
            'weekdayweekend': 'fixedteams',
            
            // 4-on-4-off variations
            'fouronfouroff': 'fouronfouroff',
            'fouronfouroffmodified': 'fouronfouroff',
            '4on4off': 'fouronfouroff',
            '44': 'fouronfouroff',
            
            // 5&2 variations
            'fiveandtwo': 'fiveandtwo',
            '52': 'fiveandtwo',
            '5and2': 'fiveandtwo',
            
            // 6&3 variations
            'sixandthree': 'sixandthree',
            '63': 'sixandthree',
            '6and3': 'sixandthree',
            
            // 7&3 variations
            'sevenandthree': 'sevenandthree',
            '73': 'sevenandthree',
            '7and3': 'sevenandthree',
            
            // Continental patterns
            'continental': 'continental',
            'continentalslowrotation': 'continental',
            
            // Panama variations
            'panama': 'panama',
            'panamaschedule': 'panama',
            '232': 'panama',
            
            // EOWEO
            'eoweo': 'eoweo',
            'everyotherweekend': 'eoweo',
            
            // Compressed Work Week
            'compressedworkweek': 'compressed',
            'compressed': 'compressed',
            '410': 'compressed',
            
            // Kelly Shift
            'kellyshift': 'kelly',
            'kelly': 'kelly',
            
            // California Shift
            'californiashift': 'california',
            'california': 'california',
            
            // Berkley variations
            'berkley': 'berkley',
            
            // Metropolitan Rota
            'metropolitanrota': 'metropolitan',
            'metropolitan': 'metropolitan',
            
            // 24-48 pattern
            '2448': 'twentyfourfortyeight',
            'twentyfourfortyeight': 'twentyfourfortyeight',
            
            // 48-96 pattern
            '4896': 'fortyeightninetysix',
            'fortyeightninetysix': 'fortyeightninetysix'
        };
        
        const basePattern = patternMap[normalizedPattern] || normalizedPattern;
        
        switch(basePattern) {
            case 'pitman':
                // PITMAN (2-2-3) PATTERN - COMPLETE IMPLEMENTATION
                const pitmanBase = [
                    1, 0, 0, 1, 1, 1, 0,  // Week 1: Sun(W), Mon-Tue(O), Wed-Fri(W), Sat(O)
                    0, 1, 1, 0, 0, 1, 1   // Week 2: Sun(O), Mon-Tue(W), Wed-Thu(O), Fri-Sat(W)
                ];
                
                const crewADay = dayOfCycle % 14;
                const crewBDay = (dayOfCycle + 7) % 14;
                const crewCDay = dayOfCycle % 14;
                const crewDDay = (dayOfCycle + 7) % 14;
                
                const aWorks = pitmanBase[crewADay];
                const bWorks = pitmanBase[crewBDay];
                const cWorks = pitmanBase[crewCDay];
                const dWorks = pitmanBase[crewDDay];
                
                let dayShiftCrews = [];
                let nightShiftCrews = [];
                
                const rotationType = rotation || 'fixed';
                
                if (rotationType === 'fixed') {
                    if (aWorks) dayShiftCrews.push('A');
                    if (bWorks) dayShiftCrews.push('B');
                    if (cWorks) nightShiftCrews.push('C');
                    if (dWorks) nightShiftCrews.push('D');
                } else if (rotationType === 'fast') {
                    const setNumber = Math.floor(dayOfCycle / 3) % 4;
                    if (setNumber % 2 === 0) {
                        if (aWorks) dayShiftCrews.push('A');
                        if (bWorks) dayShiftCrews.push('B');
                        if (cWorks) nightShiftCrews.push('C');
                        if (dWorks) nightShiftCrews.push('D');
                    } else {
                        if (aWorks) nightShiftCrews.push('A');
                        if (bWorks) nightShiftCrews.push('B');
                        if (cWorks) dayShiftCrews.push('C');
                        if (dWorks) dayShiftCrews.push('D');
                    }
                } else if (rotationType === 'medium') {
                    const cycleWeek = Math.floor(dayOfCycle / 14) % 2;
                    if (cycleWeek === 0) {
                        if (aWorks) dayShiftCrews.push('A');
                        if (bWorks) dayShiftCrews.push('B');
                        if (cWorks) nightShiftCrews.push('C');
                        if (dWorks) nightShiftCrews.push('D');
                    } else {
                        if (aWorks) nightShiftCrews.push('A');
                        if (bWorks) nightShiftCrews.push('B');
                        if (cWorks) dayShiftCrews.push('C');
                        if (dWorks) dayShiftCrews.push('D');
                    }
                } else if (rotationType === 'slow') {
                    const monthCycle = Math.floor(dayOfCycle / 28) % 2;
                    if (monthCycle === 0) {
                        if (aWorks) dayShiftCrews.push('A');
                        if (bWorks) dayShiftCrews.push('B');
                        if (cWorks) nightShiftCrews.push('C');
                        if (dWorks) nightShiftCrews.push('D');
                    } else {
                        if (aWorks) nightShiftCrews.push('A');
                        if (bWorks) nightShiftCrews.push('B');
                        if (cWorks) dayShiftCrews.push('C');
                        if (dWorks) dayShiftCrews.push('D');
                    }
                }
                
                if (dayShiftCrews.length > 0 || nightShiftCrews.length > 0) {
                    let display = [];
                    if (dayShiftCrews.length > 0) {
                        display.push(`Day: ${dayShiftCrews.join('+')}`);
                    }
                    if (nightShiftCrews.length > 0) {
                        display.push(`Night: ${nightShiftCrews.join('+')}`);
                    }
                    assignment.crews = display.join('\n');
                    assignment.cssClass = dayShiftCrews.length > 0 ? 'shift-day' : 'shift-night';
                }
                break;
                
            case 'dupont':
                // DUPONT PATTERN - 28-day cycle
                const dupontSchedule = [
                    'N','N','N','N','O','O','O',  // 4 nights, 3 off
                    'D','D','D','O',               // 3 days, 1 off
                    'N','N','N','O','O','O',       // 3 nights, 3 off
                    'D','D','D','D',               // 4 days
                    'O','O','O','O','O','O','O'    // 7 consecutive days off
                ];
                
                const dupontOffsets = {'A': 0, 'B': 7, 'C': 14, 'D': 21};
                let dupontDayCrews = [];
                let dupontNightCrews = [];
                
                for (const [crew, offset] of Object.entries(dupontOffsets)) {
                    const scheduleDay = (dayOfCycle + offset) % 28;
                    const shift = dupontSchedule[scheduleDay];
                    if (shift === 'D') dupontDayCrews.push(crew);
                    else if (shift === 'N') dupontNightCrews.push(crew);
                }
                
                if (dupontDayCrews.length > 0 || dupontNightCrews.length > 0) {
                    let display = [];
                    if (dupontDayCrews.length > 0) display.push(`Day: ${dupontDayCrews.join('+')}`);
                    if (dupontNightCrews.length > 0) display.push(`Night: ${dupontNightCrews.join('+')}`);
                    assignment.crews = display.join('\n');
                    assignment.cssClass = dupontDayCrews.length > 0 ? 'shift-day' : 'shift-night';
                }
                break;
                
            case 'southernswing':
                // Southern Swing: 8-hour shifts rotating through all shifts
                const weekInMonth = Math.floor(dayOfCycle / 7) % 4;
                const dayOfWeek = day;
                
                if (weekInMonth === 0) {
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        assignment.crews = 'All';
                        assignment.time = `${dayStart}-${eveningStart}`;
                        assignment.cssClass = 'shift-day';
                    }
                } else if (weekInMonth === 1) {
                    if (dayOfWeek >= 3 || dayOfWeek === 0) {
                        assignment.crews = 'All';
                        assignment.time = `${eveningStart}-23:00`;
                        assignment.cssClass = 'shift-evening';
                    }
                } else if (weekInMonth === 2) {
                    if (dayOfWeek <= 2 && dayOfWeek >= 1) {
                        assignment.crews = 'All';
                        assignment.time = `${eveningStart}-23:00`;
                        assignment.cssClass = 'shift-evening';
                    } else if (dayOfWeek >= 4 || dayOfWeek === 0) {
                        assignment.crews = 'All';
                        assignment.time = `23:00-${dayStart}`;
                        assignment.cssClass = 'shift-night';
                    }
                } else {
                    if (dayOfWeek >= 1 && dayOfWeek <= 3) {
                        assignment.crews = 'All';
                        assignment.time = `23:00-${dayStart}`;
                        assignment.cssClass = 'shift-night';
                    } else if (dayOfWeek >= 6 || dayOfWeek === 0) {
                        assignment.crews = 'All';
                        assignment.time = `${dayStart}-${eveningStart}`;
                        assignment.cssClass = 'shift-day';
                    }
                }
                break;
                
            case 'fouronfouroff':
                // 4-ON-4-OFF PATTERN
                const fourOnPattern = [1,1,1,1,0,0,0,0];
                const fourOnOffsets = {'A': 0, 'B': 2, 'C': 4, 'D': 6};
                
                let fourDayCrews = [];
                let fourNightCrews = [];
                
                for (const [crew, offset] of Object.entries(fourOnOffsets)) {
                    const cycleDay = (dayOfCycle + offset) % 8;
                    if (fourOnPattern[cycleDay]) {
                        if (rotation === 'fixed' || rotation?.includes('fixed')) {
                            if (crew === 'A' || crew === 'B') {
                                fourDayCrews.push(crew);
                            } else {
                                fourNightCrews.push(crew);
                            }
                        } else {
                            fourDayCrews.push(crew);
                        }
                    }
                }
                
                if (fourDayCrews.length > 0 || fourNightCrews.length > 0) {
                    let display = [];
                    if (fourDayCrews.length > 0) display.push(`Day: ${fourDayCrews.join('+')}`);
                    if (fourNightCrews.length > 0) display.push(`Night: ${fourNightCrews.join('+')}`);
                    assignment.crews = display.join('\n');
                    assignment.cssClass = fourDayCrews.length > 0 ? 'shift-day' : 'shift-night';
                }
                break;
                
            case 'fixedteams':
                // Fixed Teams (Weekday vs Weekend)
                if (day >= 1 && day <= 4) {
                    assignment.crews = 'A,B';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                } else {
                    assignment.crews = 'C,D';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'fiveandtwo':
                // 5&2 Pattern: 5 on, 2 off, 5 on, 5 off, 2 on, 2 off
                const fiveTwo = [1,1,1,1,1,0,0,1,1,1,1,1,0,0,0,0,0,1,1,0,0];
                const fiveTwoDay = dayOfCycle % 21;
                if (fiveTwo[fiveTwoDay]) {
                    assignment.crews = 'A,B';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'sixandthree':
                // 6&3 Pattern: 6 on, 3 off
                const sixThree = [1,1,1,1,1,1,0,0,0];
                if (sixThree[dayOfCycle % 9]) {
                    assignment.crews = 'A,B';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'sevenandthree':
                // 7&3 Pattern: 7 on, 3 off
                const sevenThree = [1,1,1,1,1,1,1,0,0,0];
                if (sevenThree[dayOfCycle % 10]) {
                    assignment.crews = 'Working';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'continental':
                // Continental: 2D-2E-2N-2off pattern
                const contPattern = ['D','D','E','E','N','N','O','O'];
                const contDay = dayOfCycle % 8;
                const shift = contPattern[contDay];
                
                if (shift === 'D') {
                    assignment.crews = 'Day Crew';
                    assignment.time = `${dayStart}-${eveningStart}`;
                    assignment.cssClass = 'shift-day';
                } else if (shift === 'E') {
                    assignment.crews = 'Evening Crew';
                    assignment.time = `${eveningStart}-23:00`;
                    assignment.cssClass = 'shift-evening';
                } else if (shift === 'N') {
                    assignment.crews = 'Night Crew';
                    assignment.time = `23:00-${dayStart}`;
                    assignment.cssClass = 'shift-night';
                }
                break;
                
            case 'panama':
                // Panama (2-3-2): 2 on, 2 off, 3 on, 2 off, 2 on, 3 off
                const panamaPattern = [1,1,0,0,1,1,1,0,0,1,1,0,0,0];
                if (panamaPattern[dayOfCycle % 14]) {
                    assignment.crews = 'Working';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'eoweo':
                // EOWEO: Every Other Weekend Off
                const weekNum = Math.floor(dayOfCycle / 7);
                const isWeekend = (day === 0 || day === 6);
                
                if (weekNum % 2 === 0) {
                    if (!isWeekend) {
                        assignment.crews = 'A,B';
                        assignment.time = `${dayStart}-17:00`;
                        assignment.cssClass = 'shift-day';
                    }
                } else {
                    assignment.crews = 'A,B';
                    assignment.time = `${dayStart}-17:00`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'compressed':
                // Compressed Work Week: 4x10 hour days
                if (day >= 1 && day <= 4) {
                    assignment.crews = 'All';
                    assignment.time = '07:00-17:00';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'kelly':
                // Kelly Shift: 24 on, 24 off, 24 on, 24 off, 24 on, 96 off
                const kellyPattern = [1,0,1,0,1,0,0,0,0];
                if (kellyPattern[dayOfCycle % 9]) {
                    assignment.crews = 'On Duty';
                    assignment.time = '24 hours';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'california':
                // California Shift: 3x12 hour shifts with 4 days off
                const calPattern = [1,1,1,0,0,0,0];
                if (calPattern[dayOfCycle % 7]) {
                    assignment.crews = 'Working';
                    assignment.time = `${dayStart}-${nightStart}`;
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'berkley':
                // Berkley: Fire department schedule
                const berkPattern = [1,0,1,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,1,0,1,0,0,0,0,0,0,0];
                if (berkPattern[dayOfCycle % 28]) {
                    assignment.crews = 'On Duty';
                    assignment.time = '24 hours';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'metropolitan':
                // Metropolitan Rota: 2 earlies, 2 lates, 2 nights, 4 off
                const metroPattern = ['E','E','L','L','N','N','O','O','O','O'];
                const metroDay = dayOfCycle % 10;
                const metroShift = metroPattern[metroDay];
                
                if (metroShift === 'E') {
                    assignment.crews = 'Early';
                    assignment.time = '06:00-14:00';
                    assignment.cssClass = 'shift-day';
                } else if (metroShift === 'L') {
                    assignment.crews = 'Late';
                    assignment.time = '14:00-22:00';
                    assignment.cssClass = 'shift-evening';
                } else if (metroShift === 'N') {
                    assignment.crews = 'Night';
                    assignment.time = '22:00-06:00';
                    assignment.cssClass = 'shift-night';
                }
                break;
                
            case 'twentyfourfortyeight':
                // 24-48: 24 hours on, 48 hours off
                const tfPattern = [1,0,0];
                if (tfPattern[dayOfCycle % 3]) {
                    assignment.crews = 'On Duty';
                    assignment.time = '24 hours';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            case 'fortyeightninetysix':
                // 48-96: 48 hours on, 96 hours off
                const fnsPattern = [1,1,0,0,0,0];
                if (fnsPattern[dayOfCycle % 6]) {
                    assignment.crews = 'On Duty';
                    assignment.time = '48 hours';
                    assignment.cssClass = 'shift-day';
                }
                break;
                
            default:
                // For any patterns not yet implemented
                assignment.crews = `${pattern} Pattern`;
                assignment.time = 'Configuration needed';
                assignment.cssClass = 'shift-day';
                break;
        }
        
        return assignment;
    }
    
    // ===== GENERATE SCHEDULE PREVIEW WITH TIMELINE VIEW =====
    function generateSchedulePreview() {
        console.log('===== Generating Schedule Preview =====');
        
        let rotation;
        if (pattern === 'pitman') {
            rotation = document.getElementById('pitmanVariation')?.value;
            console.log('Pitman rotation selected:', rotation);
            
            if (!rotation) {
                document.getElementById('schedulePreview').innerHTML = `
                    <div class="alert alert-warning text-center">
                        <i class="bi bi-info-circle fs-1"></i>
                        <h5 class="mt-2">Select Rotation Type</h5>
                        <p>Please choose your preferred Pitman rotation type above to see the complete schedule cycle.</p>
                    </div>
                `;
                return;
            }
        } else {
            rotation = document.getElementById('shiftRotation')?.value || 'fixed';
        }
        
        // Determine number of weeks to show
        let weeksToShow = 4;
        if (pattern === 'pitman') {
            switch(rotation) {
                case 'fixed': weeksToShow = 2; break;
                case 'fast':
                case 'medium': weeksToShow = 4; break;
                case 'slow': weeksToShow = 8; break;
            }
        }
        
        // Get pattern info for stats
        const patternInfo = patternData[pattern] || {
            cycle: '14 days',
            avgHours: '42 hours/week',
            maxConsecutive: '3 days',
            weekendsOff: 'Every other'
        };
        
        console.log('Generating preview for', weeksToShow, 'weeks');
        
        // Generate Timeline View HTML
        let previewHtml = `
            <div class="schedule-preview-container">
                <!-- Header -->
                <div class="preview-header">
                    <h4 class="preview-title">
                        <i class="bi bi-calendar-range"></i> ${patternConfig.name || pattern} Schedule Timeline
                    </h4>
                    <p class="preview-subtitle">${rotation === 'fixed' ? 'Fixed' : 'Rotating'} ${weeksToShow}-Week Cycle • Continuous 24/7 Coverage</p>
                </div>
                
                <!-- Pattern Stats -->
                <div class="pattern-stats">
                    <div class="stat-item">
                        <div class="stat-value">${patternInfo.cycle.split(' ')[0]}</div>
                        <div class="stat-label">Day Cycle</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${patternInfo.avgHours.split(' ')[0]}</div>
                        <div class="stat-label">Hours/Week</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${patternInfo.maxConsecutive.split(' ')[0]}</div>
                        <div class="stat-label">Max Days</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${patternInfo.weekendsOff.includes('Every') ? '50%' : patternInfo.weekendsOff}</div>
                        <div class="stat-label">Weekends Off</div>
                    </div>
                </div>
                
                <div class="timeline-container">
        `;
        
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const dayAbbr = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        
        // Generate weeks
        for (let week = 1; week <= weeksToShow; week++) {
            previewHtml += `
                <div class="week-timeline">
                    <div class="week-header">
                        <span class="week-number">Week ${week}</span>
                        <span class="week-info">${week === 1 ? 'Pattern begins' : week === weeksToShow ? 'Cycle completes' : 'Pattern continues'}</span>
                    </div>
                    
                    <div class="days-grid">
            `;
            
            for (let day = 0; day < 7; day++) {
                const assignment = generateCrewAssignment(pattern, week, day, rotation);
                const isWeekend = (day === 0 || day === 6);
                
                // Parse crews from assignment
                let dayCrews = [];
                let nightCrews = [];
                
                if (assignment.crews && assignment.crews !== 'Off') {
                    const lines = assignment.crews.split('\n');
                    lines.forEach(line => {
                        if (line.includes('Day:')) {
                            dayCrews = line.replace('Day:', '').trim().split('+');
                        } else if (line.includes('Night:')) {
                            nightCrews = line.replace('Night:', '').trim().split('+');
                        }
                    });
                }
                
                previewHtml += `
                    <div class="day-column">
                        <div class="day-label ${isWeekend ? 'weekend' : ''}">${dayAbbr[day]}</div>
                `;
                
                if (dayCrews.length > 0) {
                    dayCrews.forEach(crew => {
                        previewHtml += `
                            <div class="shift-block shift-day">
                                <span class="shift-label">DAY</span>
                                <span class="crew-letter">${crew}</span>
                            </div>
                        `;
                    });
                }
                
                if (nightCrews.length > 0) {
                    nightCrews.forEach(crew => {
                        previewHtml += `
                            <div class="shift-block shift-night">
                                <span class="shift-label">NIGHT</span>
                                <span class="crew-letter">${crew}</span>
                            </div>
                        `;
                    });
                }
                
                if (dayCrews.length === 0 && nightCrews.length === 0) {
                    previewHtml += `
                        <div class="shift-block shift-off">
                            <span class="crew-letter">OFF</span>
                        </div>
                    `;
                }
                
                previewHtml += `</div>`;
            }
            
            previewHtml += `
                    </div>
                </div>
            `;
        }
        
        previewHtml += `
                </div>
                
                <!-- Legend -->
                <div class="legend-strip">
                    <div class="legend-item">
                        <div class="legend-box shift-day"></div>
                        <span>Day Shift (06:00-18:00)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box shift-night"></div>
                        <span>Night Shift (18:00-06:00)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box shift-off"></div>
                        <span>Off Day</span>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('schedulePreview').innerHTML = previewHtml;
        console.log('Preview generated successfully');
    }
    
    // ===== POPULATE PATTERN INFO =====
    function populatePatternInfo() {
        const patternInfo = patternData[pattern] || {
            cycle: 'Custom',
            avgHours: '40-42 hours/week',
            maxConsecutive: 'Varies',
            weekendsOff: 'Varies',
            advantages: ['Pattern specific'],
            considerations: ['Pattern specific'],
            explanation: `${patternConfig.name || pattern} pattern implementation`
        };
        
        const infoHtml = `
            <div class="info-item">
                <span>Cycle Length:</span>
                <strong>${patternInfo.cycle}</strong>
            </div>
            <div class="info-item">
                <span>Average Hours:</span>
                <strong>${patternInfo.avgHours}</strong>
            </div>
            <div class="info-item">
                <span>Max Consecutive:</span>
                <strong>${patternInfo.maxConsecutive}</strong>
            </div>
            <div class="info-item">
                <span>Weekends Off:</span>
                <strong>${patternInfo.weekendsOff}</strong>
            </div>
            <div class="mt-3">
                <h6 class="text-success">Advantages:</h6>
                <ul class="list-unstyled">
                    ${(patternInfo.advantages || []).map(item => `<li class="text-success"><i class="bi bi-check-circle"></i> ${item}</li>`).join('')}
                </ul>
            </div>
            <div class="mt-3">
                <h6 class="text-warning">Considerations:</h6>
                <ul class="list-unstyled">
                    ${(patternInfo.considerations || []).map(item => `<li class="text-warning"><i class="bi bi-exclamation-triangle"></i> ${item}</li>`).join('')}
                </ul>
            </div>
        `;
        
        document.getElementById('patternInfo').innerHTML = infoHtml;
        document.getElementById('patternExplanation').innerHTML = `<p>${patternInfo.explanation}</p>`;
    }
    
    // ===== SET UP EVENT LISTENERS =====
    function setupEventListeners() {
        console.log('Setting up event listeners...');
        
        // Generate Preview Button
        const generateBtn = document.getElementById('generatePreviewBtn');
        if (generateBtn) {
            console.log('Generate button found');
            generateBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Generate button clicked!');
                generateSchedulePreview();
            });
        }
        
        // Refresh Preview Button
        const refreshBtn = document.getElementById('refreshPreview');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function(e) {
                e.preventDefault();
                generateSchedulePreview();
            });
        }
        
        // Pitman Variation Selector - FIXED
        if (pattern === 'pitman') {
            const pitmanSelect = document.getElementById('pitmanVariation');
            if (pitmanSelect) {
                console.log('Setting up Pitman selector');
                
                pitmanSelect.addEventListener('change', function() {
                    console.log('Pitman selection changed to:', this.value);
                    
                    const btn = document.getElementById('generatePreviewBtn');
                    if (!btn) {
                        console.error('Button not found!');
                        return;
                    }
                    
                    if (this.value) {
                        // Show button
                        btn.style.display = 'block';
                        const selectedText = this.options[this.selectedIndex].text.split('(')[0].trim();
                        btn.innerHTML = `<i class="bi bi-calendar-check"></i> Generate ${selectedText} Preview`;
                        console.log('Button shown');
                        
                        // Auto-generate preview
                        setTimeout(generateSchedulePreview, 100);
                    } else {
                        // Hide button
                        btn.style.display = 'none';
                        
                        // Show instruction
                        document.getElementById('schedulePreview').innerHTML = `
                            <div class="alert alert-info text-center">
                                <i class="bi bi-calendar-week fs-1"></i>
                                <h5 class="mt-2">Select Your Pitman Rotation Type</h5>
                                <p>Choose from the dropdown above to see the schedule preview.</p>
                            </div>
                        `;
                    }
                });
            }
        } else {
            // For non-Pitman patterns
            const rotationSelect = document.getElementById('shiftRotation');
            if (rotationSelect) {
                rotationSelect.addEventListener('change', generateSchedulePreview);
            }
        }
        
        // Create Schedule Button
        const createBtn = document.getElementById('createScheduleBtn');
        if (createBtn) {
            createBtn.addEventListener('click', function() {
                let config = {
                    pattern: pattern,
                    rotation: pattern === 'pitman' ? 
                        document.getElementById('pitmanVariation')?.value : 
                        document.getElementById('shiftRotation')?.value || 'fixed'
                };
                
                if (!config.rotation) {
                    alert('Please select a rotation type first.');
                    return;
                }
                
                alert(`Creating ${patternConfig.name || pattern} schedule with ${config.rotation} rotation...\n\nThis feature will be implemented next.`);
            });
        }
    }
    
    // ===== INITIALIZATION =====
    console.log('Starting initialization...');
    
    // Populate pattern info
    populatePatternInfo();
    
    // Set up event listeners
    setupEventListeners();
    
    // Set initial state
    if (pattern === 'pitman') {
        document.getElementById('schedulePreview').innerHTML = `
            <div class="alert alert-info text-center">
                <i class="bi bi-calendar-week fs-1"></i>
                <h5 class="mt-2">Select Your Pitman Rotation Type</h5>
                <p>Choose from Fixed, Fast, Medium, or Slow rotation above.</p>
                <p class="mb-0"><small>Each option shows different cycle lengths</small></p>
            </div>
        `;
    } else {
        setTimeout(generateSchedulePreview, 100);
    }
    
    // Make functions globally available for debugging
    window.generateSchedulePreview = generateSchedulePreview;
    window.generateCrewAssignment = generateCrewAssignment;
    
    console.log('===== Initialization Complete =====');
});
</script>
{% endblock %}
